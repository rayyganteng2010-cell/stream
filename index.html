<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayStream Home</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Cek Login
        if (!localStorage.getItem('user_info')) {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>

<header>
    <div class="logo">RayStream</div>
    <div id="userStatus"></div>
</header>

<div class="slider-container" style="display:flex; overflow-x:auto; gap:15px; padding:20px; scrollbar-width:none;">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/475ede11cdfbde3a0ed41aceeadbd3ce%20(1).jpg" style="height:180px; border-radius:16px; width:85%; object-fit:cover; flex-shrink:0;">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/ec12a7175835f59a38e9a2082bc47b29.jpg" style="height:180px; border-radius:16px; width:85%; object-fit:cover; flex-shrink:0;">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/0c96d013d87134ba7d2c951a889ebf15.jpg" style="height:180px; border-radius:16px; width:85%; object-fit:cover; flex-shrink:0;">
</div>

<div class="container">
    <div class="section-header">
        <h3>Popular Today</h3>
    </div>
    <div id="popularData" class="grid">
        <p style="color:#555;">Loading...</p>
    </div>

    <div class="section-header">
        <h3>Latest Release</h3>
        <span id="pageIndicator" style="font-size:0.8rem; color:#666;"></span>
    </div>
    
    <div id="latestData" class="grid">
        </div>

    <button id="btnLoadMore" class="btn-load-more" onclick="loadNextPage()">
        
    </button>
</div>

<nav class="bottom-nav">
    <a href="index.html" class="nav-item active"><i data-lucide="home"></i></a>
    <a href="schedule.html" class="nav-item"><i data-lucide="calendar"></i></a>
    <a href="history.html" class="nav-item"><i data-lucide="history"></i></a>
</nav>

<script>
    const API_BASE = "https://anichin-seven.vercel.app/api";

    // LOGIC PAGE ROTATION
    // Ambil page terakhir dari storage, tambah 1. Kalau > 5 balik ke 1.
    let storedPage = parseInt(localStorage.getItem('current_page')) || 0; 
    let currentPage = storedPage + 1;
    if (currentPage > 5) currentPage = 1; // Loop 1-5
    
    // Simpan page sekarang buat kunjungan berikutnya
    localStorage.setItem('current_page', currentPage);

    // Update UI Indicator
    document.getElementById('pageIndicator').innerText = `Page ${currentPage}`;

    // Helper: Slug Cleaner
    function getCleanSlug(href) {
        if (!href) return '';
        href = href.replace(/\/$/, '');
        let segment = href.substring(href.lastIndexOf('/') + 1);
        return segment.replace(/-episode-\d+.*$/i, '');
    }

    // 1. Load Popular
    async function loadPopular() {
        try {
            const res = await fetch(`${API_BASE}/popular`);
            const data = await res.json();
            document.getElementById('popularData').innerHTML = data.data.slice(0, 6).map(item => `
                <div class="card" onclick="window.location.href='series.html?slug=${getCleanSlug(item.href)}'">
                    <img src="${item.poster}" loading="lazy">
                    <p>${item.title}</p>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    // 2. Load Latest (Sesuai Page Saat Ini)
    async function loadLatest(pageNum) {
        try {
            const btn = document.getElementById('btnLoadMore');
            btn.innerText = "Loading...";
            
            const res = await fetch(`${API_BASE}/list?page=${pageNum}`);
            const data = await res.json();
            
            // Append (tambah ke bawah) bukan replace
            const container = document.getElementById('latestData');
            
            const html = data.data.map(item => `
                <div class="card" onclick="window.location.href='series.html?slug=${getCleanSlug(item.href)}'">
                    <img src="${item.poster}" loading="lazy">
                    <p>${item.title}</p>
                </div>
            `).join('');

            container.insertAdjacentHTML('beforeend', html);
            
            btn.innerText = "Load Next Page";
        } catch (e) { 
            console.error(e);
            document.getElementById('btnLoadMore').innerText = "Error loading";
        }
    }

    // 3. Fungsi Tombol Next Page
    function loadNextPage() {
        currentPage++; // Naikkan counter page session ini
        loadLatest(currentPage);
    }

    // Tampilkan Avatar User
    const user = JSON.parse(localStorage.getItem('user_info'));
    if(user) {
        document.getElementById('userStatus').innerHTML = `
            <img src="${user.picture}" style="width:36px; height:36px; border-radius:50%; border:2px solid var(--primary); cursor:pointer;" onclick="window.location.href='history.html'">
        `;
    }

    // Init
    loadPopular();
    loadLatest(currentPage); // Load page hasil rotasi
    lucide.createIcons();
</script>
</body>
</html>
