<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayStream Premium</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Auth sederhana
        if (!localStorage.getItem('user_info')) window.location.href = 'login.html';
    </script>
</head>
<body>

<header>
    <div class="logo">RAYSTREAM</div>
    <div class="search-icon-btn" onclick="window.location.href='search.html'">
        <i data-lucide="search" style="color:#fff; width:20px;"></i>
    </div>
</header>

<div class="container">
    
    <div class="genre-scroll">
        <a href="search.html" class="genre-chip active">All</a>
        <a href="search.html?query=action" class="genre-chip">Action</a>
        <a href="search.html?query=adventure" class="genre-chip">Adventure</a>
        <a href="search.html?query=fantasy" class="genre-chip">Fantasy</a>
        <a href="search.html?query=isekai" class="genre-chip">Isekai</a>
        <a href="search.html?query=magic" class="genre-chip">Magic</a>
        <a href="search.html?query=romance" class="genre-chip">Romance</a>
    </div>

    <div class="section-header">
        <div class="section-title">New Releases</div>
        <a href="search.html?type=ongoing" class="section-link">View All</a>
    </div>
    
    <div id="latestGrid" class="grid">
        <div class="card skeleton"></div>
        <div class="card skeleton"></div>
        <div class="card skeleton"></div>
    </div>

    <div style="margin-top: 40px; text-align: center;">
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('popular', this)">Popular</button>
            <button class="tab-btn" onclick="switchTab('completed', this)">Completed</button>
        </div>
    </div>
    
    <div id="dynamicGrid" class="grid">
        <div class="card skeleton"></div>
        <div class="card skeleton"></div>
    </div>

    <button class="load-more-btn" onclick="window.location.href='search.html'">Explore More Content</button>

</div>

<nav class="bottom-nav">
    <a href="index.html" class="nav-item active"><i data-lucide="home"></i></a>
    <a href="schedule.html" class="nav-item"><i data-lucide="calendar"></i></a>
    <a href="history.html" class="nav-item"><i data-lucide="clock"></i></a>
</nav>

<script>
    // --- KONFIGURASI API ---
    const API_ANIME   = "https://donghua-qnha.vercel.app/anime/samehadaku";
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";

    // --- 1. LOAD ONGOING (LATEST) ---
    async function loadLatest() {
        const grid = document.getElementById('latestGrid');
        try {
            // Kita fetch Anime Ongoing (Sesuai endpoint kamu) & Donghua List
            const [resA, resD] = await Promise.all([
                fetch(`${API_ANIME}/ongoing?page=1`),
                fetch(`${API_DONGHUA}/list?page=1`)
            ]);

            const jsonA = await resA.json(); // Struktur: { data: { animeList: [] } }
            const jsonD = await resD.json(); // Struktur: { result: [] } (Asumsi Donghua)

            // Parsing Data Anime (Perbaikan Utama)
            const animeList = (jsonA.data?.animeList || []).slice(0, 6).map(item => ({
                title: item.title,
                poster: item.poster,
                id: item.animeId, // Menggunakan animeId sesuai JSON
                score: item.score || '?',
                source: 'anime',
                type: item.type || 'TV'
            }));

            // Parsing Data Donghua
            const donghuaList = (jsonD.result || []).slice(0, 6).map(item => ({
                title: item.title,
                poster: item.thumbnail,
                id: item.url, // URL untuk donghua
                score: item.update || 'On',
                source: 'donghua',
                type: 'ONA'
            }));

            // Gabung & Render
            const combined = interleave(animeList, donghuaList);
            renderGrid(grid, combined);

        } catch(e) {
            console.error("Load Latest Error:", e);
            grid.innerHTML = `<p style="color:#ef4444;">Gagal memuat data. Periksa koneksi.</p>`;
        }
    }

    // --- 2. SWITCH TAB (POPULAR / COMPLETED) ---
    async function switchTab(type, btn) {
        // UI Handling
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const grid = document.getElementById('dynamicGrid');
        grid.innerHTML = '<div class="card skeleton"></div><div class="card skeleton"></div>';

        try {
            let animeData = [];
            let donghuaData = [];

            if (type === 'completed') {
                // Fetch Completed Anime
                const resA = await fetch(`${API_ANIME}/completed?page=1`);
                const jsonA = await resA.json();
                animeData = (jsonA.data?.animeList || []).slice(0, 8).map(item => ({
                    title: item.title,
                    poster: item.poster,
                    id: item.animeId, // FIX: pakai animeId
                    score: item.score,
                    source: 'anime',
                    type: 'END'
                }));

                // Fetch Completed Donghua
                const resD = await fetch(`${API_DONGHUA}/completed`);
                const jsonD = await resD.json();
                donghuaData = (jsonD.result || []).slice(0, 8).map(item => ({
                    title: item.title,
                    poster: item.thumbnail,
                    id: item.url,
                    score: 'End',
                    source: 'donghua',
                    type: 'END'
                }));
            } 
            else if (type === 'popular') {
                // Fetch Popular (Asumsi endpoint popular anime strukturnya sama)
                const resA = await fetch(`${API_ANIME}/popular?page=1`);
                const jsonA = await resA.json();
                animeData = (jsonA.data?.animeList || []).slice(0, 8).map(item => ({
                    title: item.title,
                    poster: item.poster,
                    id: item.animeId,
                    score: item.score,
                    source: 'anime',
                    type: 'HOT'
                }));

                const resD = await fetch(`${API_DONGHUA}/popular`);
                const jsonD = await resD.json();
                donghuaData = (jsonD.result || []).slice(0, 8).map(item => ({
                    title: item.title,
                    poster: item.thumbnail,
                    id: item.url,
                    score: 'Hot',
                    source: 'donghua',
                    type: 'HOT'
                }));
            }

            renderGrid(grid, interleave(animeData, donghuaData));

        } catch(e) {
            console.error(e);
            grid.innerHTML = `<p style="color:#ef4444;">Gagal memuat tab ${type}.</p>`;
        }
    }

    // --- HELPER FUNCTIONS ---
    
    // Fungsi render kartu HTML
    function renderGrid(container, items) {
        container.innerHTML = items.map(item => {
            const badgeClass = item.source === 'anime' ? 'bg-anime' : 'bg-donghua';
            // Untuk link: Anime pakai ID, Donghua pakai URL
            return `
            <div class="card" onclick="goToSeries('${item.id}', '${item.source}')">
                <div class="badge-top ${badgeClass}">${item.source}</div>
                <img src="${item.poster}" alt="${item.title}" loading="lazy">
                <div class="card-content">
                    <div class="card-title">${item.title}</div>
                    <div class="badge-score">
                        <i data-lucide="star" style="width:12px; fill:#ffd700;"></i>
                        ${item.score}
                    </div>
                </div>
            </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    function goToSeries(id, source) {
        // Encode URI component agar aman
        window.location.href = `series.html?slug=${encodeURIComponent(id)}&source=${source}`;
    }

    // Fungsi untuk selang-seling (mix) array Anime dan Donghua
    function interleave(arr1, arr2) {
        const result = [];
        const maxLength = Math.max(arr1.length, arr2.length);
        for (let i = 0; i < maxLength; i++) {
            if (i < arr1.length) result.push(arr1[i]);
            if (i < arr2.length) result.push(arr2[i]);
        }
        return result;
    }

    // INIT
    loadLatest();
    // Load tab popular sebagai default saat tombol pertama diklik otomatis
    document.querySelector('.tab-btn.active').click();
    lucide.createIcons();
</script>
</body>
</html>
