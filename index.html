<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RayStream</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<header class="topbar">
  <div class="topbar-left">
    <div class="brand">RAYSTREAM</div>
    <div class="subtitle">Nonton, bukan nonton iklan</div>
  </div>

  <div class="topbar-right">
    <div class="source-switch" id="sourceSwitch">
      <button class="pill active" data-source="donghua">Donghua</button>
      <button class="pill" data-source="anime">Anime</button>
    </div>
  </div>
</header>

<main class="container">

  <section class="panel">
    <div class="panel-head">
      <div class="tabs" id="tabs">
        <button class="tab active" data-cat="latest">Latest</button>
        <button class="tab" data-cat="ongoing">Ongoing</button>
        <button class="tab" data-cat="completed">Completed</button>
      </div>

      <div class="pager">
        <button class="btn btn-ghost" id="prevPage" disabled>
          <i data-lucide="chevron-left"></i>
        </button>
        <div class="page-indicator">
          Page <span id="pageNum">1</span>
        </div>
        <button class="btn btn-ghost" id="nextPage">
          <i data-lucide="chevron-right"></i>
        </button>
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <div id="emptyState" class="empty" style="display:none;">
      <div class="empty-title">Kosong.</div>
      <div class="empty-sub">Entah API-nya yang ngambek atau kamu lagi apes.</div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>Loading...</div>
    </div>
  </section>

</main>

<script>
  // =========================
  // ENDPOINTS
  // =========================
  const API_DONGHUA = "https://anichin-seven.vercel.app/api";
  const API_ANIME   = "https://donghua-qnha.vercel.app/anime/samehadaku";

  // Category mapping:
  // - donghua: /ongoing, /completed, (latest pakai /list atau /latest yang kamu punya)
  // - anime:   /ongoing, /completed, (latest coba /latest atau /list kalau ada)
  const CAT_TO_PATH = {
    latest:   { donghua: "/list",      anime: "/latest" },   // fallback handling below
    ongoing:  { donghua: "/ongoing",   anime: "/ongoing" },
    completed:{ donghua: "/completed", anime: "/completed" }
  };

  // =========================
  // STATE
  // =========================
  let state = {
    source: "donghua", // donghua | anime
    cat: "latest",     // latest | ongoing | completed
    page: 1
  };

  const els = {
    grid: document.getElementById("grid"),
    loading: document.getElementById("loading"),
    empty: document.getElementById("emptyState"),
    pageNum: document.getElementById("pageNum"),
    prev: document.getElementById("prevPage"),
    next: document.getElementById("nextPage"),
    tabs: document.getElementById("tabs"),
    switch: document.getElementById("sourceSwitch")
  };

  function setLoading(on) {
    els.loading.style.display = on ? "flex" : "none";
  }

  function setEmpty(on) {
    els.empty.style.display = on ? "block" : "none";
  }

  function safeText(s) {
    return (s ?? "").toString().trim();
  }

  function buildUrl() {
    const base = state.source === "donghua" ? API_DONGHUA : API_ANIME;
    const path = CAT_TO_PATH[state.cat]?.[state.source];

    // page query: kebanyakan endpoint list support ?page=
    // ongoing/completed kadang support page juga, kita coba aja
    return `${base}${path}?page=${state.page}`;
  }

  async function fetchJsonTry(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  async function fetchList() {
    setEmpty(false);
    setLoading(true);
    els.grid.innerHTML = "";
    els.pageNum.innerText = state.page;

    // Prev disable logic
    els.prev.disabled = state.page <= 1;

    let url = buildUrl();
    let json;

    try {
      json = await fetchJsonTry(url);
    } catch (e) {
      // Fallback untuk "latest" karena kamu punya berbagai varian endpoint.
      if (state.cat === "latest") {
        try {
          const base = state.source === "donghua" ? API_DONGHUA : API_ANIME;
          const fallback = state.source === "donghua"
            ? `${base}/latest?page=${state.page}`
            : `${base}/list?page=${state.page}`;

          json = await fetchJsonTry(fallback);
        } catch (e2) {
          setLoading(false);
          setEmpty(true);
          return;
        }
      } else {
        setLoading(false);
        setEmpty(true);
        return;
      }
    }

    // Normalisasi data: beberapa API pakai data, beberapa list
    const list =
      json?.data ||
      json?.results ||
      json?.animeList ||
      json?.donghuaList ||
      json?.list ||
      [];

    if (!Array.isArray(list) || list.length === 0) {
      setLoading(false);
      setEmpty(true);
      return;
    }

    renderCards(list);
    setLoading(false);
    lucide.createIcons();
  }

  function pickCardFields(item) {
    // donghua (anichin-seven) biasanya: { title, poster, status, type, anichinUrl }
    // anime (samehadaku proxy) bisa: { title, poster, type, score, animeId, href, samehadakuUrl }
    const title = safeText(item.title) || safeText(item.name);
    const poster = item.poster || item.thumbnail || item.image || "";
    const type = safeText(item.type);
    const status = safeText(item.status);
    const score = safeText(item.score);

    // target link:
    // - donghua series: series.html?slug=...&source=donghua
    // - anime series: series.html?slug=...&source=anime
    let rawUrl = item.anichinUrl || item.samehadakuUrl || item.href || item.url || "";

    return { title, poster, type, status, score, rawUrl, item };
  }

  function resolveSeriesSlug(rawUrl, item) {
    // Kalau punya animeId langsung bagus
    if (item.animeId) return item.animeId;

    // fallback: ambil path terakhir
    if (!rawUrl) return "";
    const clean = rawUrl.replace(/\/$/, "").split("/").pop();
    // buang "-episode-xx" kalau nyasar episode
    return clean.replace(/-episode-\d+.*$/i, "");
  }

  function renderCards(list) {
    els.grid.innerHTML = list.map((it) => {
      const { title, poster, type, status, score, rawUrl, item } = pickCardFields(it);
      const slug = resolveSeriesSlug(rawUrl, item);

      const metaLeft = status || type || "—";
      const metaRight = score ? `⭐ ${score}` : "";

      return `
        <article class="card" onclick="goSeries('${encodeURIComponent(slug)}')">
          <div class="thumb">
            <img loading="lazy" src="${poster}" alt="${title}">
          </div>
          <div class="card-body">
            <div class="card-title" title="${title}">${title}</div>
            <div class="card-meta">
              <span>${metaLeft}</span>
              <span>${metaRight}</span>
            </div>
          </div>
        </article>
      `;
    }).join("");
  }

  window.goSeries = function(slugEnc) {
    const slug = decodeURIComponent(slugEnc || "");
    if (!slug) return;
    window.location.href = `series.html?slug=${encodeURIComponent(slug)}&source=${state.source}`;
  };

  // =========================
  // UI EVENTS
  // =========================
  els.switch.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-source]");
    if (!btn) return;

    document.querySelectorAll("#sourceSwitch .pill").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");

    state.source = btn.dataset.source;
    state.page = 1;
    fetchList();
  });

  els.tabs.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-cat]");
    if (!btn) return;

    document.querySelectorAll("#tabs .tab").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");

    state.cat = btn.dataset.cat;
    state.page = 1;
    fetchList();
  });

  els.prev.addEventListener("click", () => {
    if (state.page <= 1) return;
    state.page--;
    fetchList();
  });

  els.next.addEventListener("click", () => {
    state.page++;
    fetchList();
  });

  // start
  fetchList();
  lucide.createIcons();
</script>

</body>
        </html>
