<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayStream - Home</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        if (!localStorage.getItem('user_info')) window.location.href = 'login.html';
    </script>
</head>
<body>

<header>
    <div class="logo">RayStream</div>
    <div id="userStatus" onclick="window.location.href='history.html'" style="cursor:pointer;"></div>
</header>

<div class="tab-container">
    <button class="tab-btn active" onclick="switchTab('home')">Home</button>
    <button class="tab-btn" onclick="switchTab('ongoing')">Ongoing</button>
    <button class="tab-btn" onclick="switchTab('completed')">Completed</button>
</div>

<div id="view-home">
    <div class="slider-container">
        <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/475ede11cdfbde3a0ed41aceeadbd3ce%20(1).jpg" class="slider-img">
        <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/ec12a7175835f59a38e9a2082bc47b29.jpg" class="slider-img">
    </div>

    <div class="container">
        <div class="section-title">
            <h3>Popular Today</h3>
        </div>
        <div id="popularData" class="grid">
            <div class="card skeleton"></div><div class="card skeleton"></div><div class="card skeleton"></div>
        </div>

        <div class="section-title">
            <h3>Latest Updates</h3>
        </div>
        <div id="homeData" class="grid"></div>
        <div style="text-align:center; padding:20px;">
            <button onclick="loadMixedHome()" style="background:#222; border:1px solid #333; color:white; padding:10px 20px; border-radius:20px;">Load More</button>
        </div>
    </div>
</div>

<div id="view-ongoing" style="display:none;">
    <div class="container">
        <div class="section-title"><h3>Ongoing Series</h3></div>
        <div id="ongoingData" class="grid"></div>
    </div>
</div>

<div id="view-completed" style="display:none;">
    <div class="container">
        <div class="section-title"><h3>Completed Series</h3></div>
        <div id="completedData" class="grid"></div>
    </div>
</div>

<nav class="bottom-nav">
    <a href="index.html" class="nav-item active"><i data-lucide="home"></i></a>
    <a href="schedule.html" class="nav-item"><i data-lucide="calendar"></i></a>
    <a href="history.html" class="nav-item"><i data-lucide="history"></i></a>
</nav>

<script>
    // --- API ENDPOINTS ---
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    // Using proxy for Samehadaku access
    const API_ANIME = "https://donghua-qnha.vercel.app/anime/samehadaku";

    // --- USER AVATAR ---
    const user = JSON.parse(localStorage.getItem('user_info'));
    if(user) {
        document.getElementById('userStatus').innerHTML = `<img src="${user.picture}" style="width:34px; height:34px; border-radius:50%; border:2px solid var(--primary);">`;
    }

    // --- TAB SWITCHER ---
    function switchTab(tabName) {
        // Hide All Views
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-ongoing').style.display = 'none';
        document.getElementById('view-completed').style.display = 'none';
        
        // Reset Buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        // Show Selected
        document.getElementById(`view-${tabName}`).style.display = 'block';
        event.target.classList.add('active'); // Highlight button clicked

        // Load Data if empty
        if(tabName === 'ongoing' && document.getElementById('ongoingData').innerHTML === "") loadOngoing();
        if(tabName === 'completed' && document.getElementById('completedData').innerHTML === "") loadCompleted();
    }

    // --- 1. LOAD HOME (POPULAR + LATEST) ---
    async function loadHome() {
        // Popular (Donghua Only for simplicity)
        fetch(`${API_DONGHUA}/popular`)
            .then(r=>r.json())
            .then(d => renderCards(d.data.slice(0,6), 'popularData', 'donghua'));

        loadMixedHome();
    }

    let homePage = 1;
    async function loadMixedHome() {
        // Fetch Donghua List & Anime Recent in parallel
        const [resD, resA] = await Promise.all([
            fetch(`${API_DONGHUA}/list?page=${homePage}`).then(r=>r.json()),
            fetch(`${API_ANIME}/home`).then(r=>r.json()) // Anime recent
        ]);

        const listD = normalizeDonghua(resD.data);
        // Be careful, anime recent structure might vary
        const listA = resA.data?.recent?.animeList ? normalizeAnime(resA.data.recent.animeList) : [];

        // Merge & Render
        const mixed = [...listA, ...listD]; 
        renderCards(mixed, 'homeData', 'mixed');
        homePage++;
    }

    // --- 2. LOAD ONGOING ---
    async function loadOngoing() {
        const container = document.getElementById('ongoingData');
        container.innerHTML = '<p style="color:#666;">Loading Ongoing...</p>';

        try {
            const [resD, resA] = await Promise.all([
                fetch(`${API_DONGHUA}/ongoing?page=1`).then(r=>r.json()),
                fetch(`${API_ANIME}/ongoing?page=1`).then(r=>r.json())
            ]);

            const listD = normalizeDonghua(resD.data);
            // Check Anime Ongoing structure (usually data.animeList)
            const listA = resA.data?.animeList ? normalizeAnime(resA.data.animeList) : [];

            renderCards([...listA, ...listD], 'ongoingData', 'mixed');
        } catch(e) { console.error(e); }
    }

    // --- 3. LOAD COMPLETED ---
    async function loadCompleted() {
        const container = document.getElementById('completedData');
        container.innerHTML = '<p style="color:#666;">Loading Completed...</p>';

        try {
            const [resD, resA] = await Promise.all([
                fetch(`${API_DONGHUA}/completed?page=1`).then(r=>r.json()),
                fetch(`${API_ANIME}/completed?page=1`).then(r=>r.json())
            ]);

            const listD = normalizeDonghua(resD.data);
            const listA = resA.data?.animeList ? normalizeAnime(resA.data.animeList) : [];

            renderCards([...listA, ...listD], 'completedData', 'mixed');
        } catch(e) { console.error(e); }
    }

    // --- HELPERS: NORMALIZE DATA ---
    function normalizeDonghua(list) {
        if(!list) return [];
        return list.map(item => ({
            title: item.title,
            poster: item.poster,
            ep: item.current_episode || item.episode || "Ep ?", // Handle different field names
            slug: getCleanSlug(item.href),
            type: 'donghua'
        }));
    }

    function normalizeAnime(list) {
        if(!list) return [];
        return list.map(item => ({
            title: item.title,
            poster: item.poster,
            ep: item.episodes || "Ep ?",
            slug: item.animeId, // Anime ID is usually clean
            type: 'anime'
        }));
    }

    function getCleanSlug(url) {
        if(!url) return "";
        return url.replace(/\/$/, '').split('/').pop().replace(/-episode-\d+.*$/i, '');
    }

    // --- CARD RENDERER ---
    function renderCards(list, elementId, mode) {
        const container = document.getElementById(elementId);
        if(container.innerHTML.includes('Loading')) container.innerHTML = ""; // Clear loader

        const html = list.map(item => {
            // Determine destination link
            let link = `series.html?slug=${item.slug}&source=${item.type}`;
            
            // Badge Class
            let badgeClass = item.type === 'anime' ? 'tag-anime' : 'tag-donghua';
            let label = item.type.toUpperCase();

            return `
            <div class="card" onclick="window.location.href='${link}'">
                <span class="type-tag ${badgeClass}">${label}</span>
                <img src="${item.poster}" loading="lazy">
                <div class="card-info">
                    <div class="card-title">${item.title}</div>
                    <div class="card-ep">${item.ep}</div>
                </div>
            </div>
            `;
        }).join('');

        if (mode === 'popularData' || mode === 'mixed') {
             if (container.innerHTML === "") container.innerHTML = html; // First load
             else container.insertAdjacentHTML('beforeend', html); // Load more
        } else {
             container.innerHTML = html; // Replace content
        }
    }

    // Init
    loadHome();
    lucide.createIcons();
</script>
</body>
</html>
