<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayStream Home</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Cek Login
        if (!localStorage.getItem('user_info')) {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>

<header>
    <div class="logo">RayStream</div>
    <div id="userStatus"></div>
    <!-- Search Bar -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search..." oninput="searchContent()">
    </div>
</header>

<div class="slider-container" style="display:flex; overflow-x:auto; gap:15px; padding:20px; scrollbar-width:none;">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/475ede11cdfbde3a0ed41aceeadbd3ce%20(1).jpg" class="slider-img">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/ec12a7175835f59a38e9a2082bc47b29.jpg" class="slider-img">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/0c96d013d87134ba7d2c951a889ebf15.jpg" class="slider-img">
</div>

<div class="container">
    <div class="section-header">
        <h3>Popular Donghua</h3>
    </div>
    <div id="popularData" class="grid">
        <p style="color:#555;">Loading...</p>
    </div>

    <div class="section-header">
        <h3>Latest Release</h3>
        <span id="pageIndicator" style="font-size:0.8rem; color:#666;">Page 1</span>
    </div>
    
    <div id="latestData" class="grid">
        </div>

    <button id="btnLoadMore" class="btn btn-primary" onclick="loadNextPage()">
        Load Next Page
    </button>

    <!-- Genres Section -->
    <div class="section-header">
        <h3>Genres</h3>
    </div>
    <div id="genresData" class="genres-list">
        <p style="color:#555;">Loading Genres...</p>
    </div>

    <!-- Combined Search Results Section -->
    <div class="section-header">
        <h3>Search Results</h3>
    </div>
    <div id="searchResultsData" class="grid">
        <p style="color:#555;">Please enter a search query...</p>
    </div>
</div>

<nav class="bottom-nav">
    <a href="index.html" class="nav-item active"><i data-lucide="home"></i></a>
    <a href="schedule.html" class="nav-item"><i data-lucide="calendar"></i></a>
    <a href="history.html" class="nav-item"><i data-lucide="history"></i></a>
</nav>

<script>
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    const API_ANIME_SEARCH = "https://donghua-qnha.vercel.app/anime/samehadaku/search?query=";
    const API_SEARCH = "https://anichin-seven.vercel.app/api/search?s=";
    const API_GENRES = "https://anichin-seven.vercel.app/api/genres";
    const API_COMPLETED_DONGHUA = "https://anichin-seven.vercel.app/api/completed";
    const API_ONGOING_DONGHUA = "https://anichin-seven.vercel.app/api/ongoing";
    
    // Caching variables
    let searchResults = [];

    // Helper: Slug Cleaner untuk Anichin
    function getCleanSlug(href) {
        if (!href) return '';
        href = href.replace(/\/$/, '');
        let segment = href.substring(href.lastIndexOf('/') + 1);
        return segment.replace(/-episode-\d+.*$/i, '');
    }

    // Load Search Results for both Anime and Donghua
    async function searchContent() {
        const query = document.getElementById('searchInput').value;
        if (query.length < 3) {
            document.getElementById('searchResultsData').innerHTML = "<p style='color:#555;'>Please enter a search query...</p>";
            return;
        }

        try {
            // Fetch Anime Search Results
            const animeRes = await fetch(`${API_ANIME_SEARCH}${query}`);
            const animeData = await animeRes.json();

            // Fetch Donghua Search Results
            const donghuaRes = await fetch(`${API_SEARCH}${query}`);
            const donghuaData = await donghuaRes.json();

            // Merge both anime and donghua data into a single list
            const combinedResults = [
                ...animeData.data.animeList.map(item => ({
                    title: item.title,
                    poster: item.poster,
                    type: 'anime',
                    slug: item.animeId,
                    href: item.href,
                    genres: item.genreList
                })),
                ...donghuaData.data.map(item => ({
                    title: item.title,
                    poster: item.poster,
                    type: 'donghua',
                    slug: getCleanSlug(item.href),
                    href: item.href,
                    genres: item.genres
                }))
            ];

            // Display combined search results
            if (combinedResults.length > 0) {
                document.getElementById('searchResultsData').innerHTML = combinedResults.map(item => `
                    <div class="card" onclick="window.location.href='series.html?slug=${item.slug}&type=${item.type}'">
                        <span class="type-badge ${item.type === 'donghua' ? 'bg-donghua' : 'bg-anime'}">${item.type.toUpperCase()}</span>
                        <img src="${item.poster}" loading="lazy">
                        <p>${item.title}</p>
                    </div>
                `).join('');
            } else {
                document.getElementById('searchResultsData').innerHTML = "<p style='color:#555;'>No results found.</p>";
            }
        } catch (error) {
            console.error("Error fetching search results:", error);
            document.getElementById('searchResultsData').innerHTML = "<p style='color:#555;'>An error occurred while fetching results. Please try again.</p>";
        }
    }

    // Init
    loadGenres();
    lucide.createIcons();
</script>
</body>
</html>
