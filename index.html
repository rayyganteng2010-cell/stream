<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayStream - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // AUTH CHECK
        if (!localStorage.getItem('user_info')) window.location.href = 'login.html';
    </script>
</head>
<body>

<header>
    <div class="logo">RAYSTREAM</div>
    <div onclick="window.location.href='search.html'" style="background:#222; padding:8px; border-radius:50%; cursor:pointer;">
        <i data-lucide="search" style="width:20px; color:#fff;"></i>
    </div>
</header>

<div class="container">
    
    <div id="genreList" class="genre-scroll">
        <div class="genre-chip">Loading Genres...</div>
    </div>

    <div class="section-title">
        <span>Latest Updates</span>
        <a href="search.html?type=ongoing" style="font-size:0.8rem; color:var(--primary); text-decoration:none;">View All</a>
    </div>
    <div id="latestGrid" class="grid">
        <div class="card skeleton" style="height:200px;"></div>
        <div class="card skeleton" style="height:200px;"></div>
    </div>

    <div style="margin-top: 30px;">
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('popular')">Popular</button>
            <button class="tab-btn" onclick="switchTab('completed')">Completed</button>
        </div>
        
        <div id="dynamicGrid" class="grid"></div>
    </div>

</div>

<nav class="bottom-nav">
    <a href="index.html" class="nav-item active"><i data-lucide="home"></i></a>
    <a href="schedule.html" class="nav-item"><i data-lucide="calendar"></i></a>
    <a href="history.html" class="nav-item"><i data-lucide="history"></i></a>
</nav>

<script>
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    const API_ANIME   = "https://donghua-qnha.vercel.app/anime/samehadaku";

    // --- 1. LOAD GENRES ---
    async function loadGenres() {
        try {
            const res = await fetch(`${API_DONGHUA}/genres`);
            const data = await res.json();
            const list = document.getElementById('genreList');
            
            // Tambahkan tombol statis untuk Anime/Donghua umum
            let html = `
                <a href="search.html" class="genre-chip" style="background:var(--primary); border-color:var(--primary);">All</a>
                <a href="search.html?query=action" class="genre-chip">Action</a>
                <a href="search.html?query=romance" class="genre-chip">Romance</a>
            `;

            // Render Genre dari API Donghua
            data.forEach(g => {
                // Link ke search.html dengan parameter genre
                html += `<a href="search.html?genre=${g.endpoint}" class="genre-chip">${g.title}</a>`;
            });
            
            list.innerHTML = html;
        } catch(e) { console.log("Genre Err", e); }
    }

    // --- 2. LOAD LATEST (Mix Anime & Donghua) ---
    async function loadLatest() {
        const grid = document.getElementById('latestGrid');
        try {
            // Ambil data parallel
            const [resD, resA] = await Promise.all([
                fetch(`${API_DONGHUA}/list?page=1`),
                fetch(`${API_ANIME}/ongoing?page=1`) // Anime ongoing dianggap latest
            ]);

            const jsonD = await resD.json();
            const jsonA = await resA.json();

            // Format Data Donghua
            const donghuaItems = (jsonD.result || []).slice(0, 6).map(item => ({
                title: item.title,
                poster: item.thumbnail,
                url: item.url, // Full URL
                source: 'donghua',
                ep: item.update || 'Ep ?'
            }));

            // Format Data Anime
            const animeItems = (jsonA.data || []).slice(0, 6).map(item => ({
                title: item.title,
                poster: item.poster,
                url: item.slug, // Slug only
                source: 'anime',
                ep: item.latestEpisode || 'Ep ?'
            }));

            // Gabung dan Acak sedikit biar variatif (atau sort by date kalau ada)
            const combined = [...donghuaItems, ...animeItems];

            grid.innerHTML = combined.map(item => createCard(item)).join('');

        } catch(e) {
            grid.innerHTML = "<p>Gagal memuat update terbaru.</p>";
            console.error(e);
        }
    }

    // --- 3. TAB LOGIC (Popular / Completed) ---
    let currentTab = 'popular';
    
    async function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        const grid = document.getElementById('dynamicGrid');
        grid.innerHTML = '<div class="card skeleton"></div><div class="card skeleton"></div><div class="card skeleton"></div>';

        try {
            let items = [];
            if(tab === 'popular') {
                // Fetch Popular Anime & Donghua
                const [d, a] = await Promise.all([
                    fetch(`${API_DONGHUA}/popular`).then(r=>r.json()),
                    fetch(`${API_ANIME}/popular?page=1`).then(r=>r.json())
                ]);
                
                // Map Donghua
                const listD = (d.result || d || []).slice(0,6).map(i => ({
                    title: i.title, poster: i.thumbnail, url: i.url, source: 'donghua', ep: 'Hot'
                }));
                // Map Anime
                const listA = (a.data || []).slice(0,6).map(i => ({
                    title: i.title, poster: i.poster, url: i.slug, source: 'anime', ep: i.score || 'Hot'
                }));
                items = [...listD, ...listA];

            } else if (tab === 'completed') {
                // Fetch Completed
                const [d, a] = await Promise.all([
                    fetch(`${API_DONGHUA}/completed`).then(r=>r.json()),
                    fetch(`${API_ANIME}/completed?page=1`).then(r=>r.json())
                ]);

                const listD = (d.result || d || []).slice(0,6).map(i => ({
                    title: i.title, poster: i.thumbnail, url: i.url, source: 'donghua', ep: 'End'
                }));
                const listA = (a.data || []).slice(0,6).map(i => ({
                    title: i.title, poster: i.poster, url: i.slug, source: 'anime', ep: 'End'
                }));
                items = [...listD, ...listA];
            }

            grid.innerHTML = items.map(item => createCard(item)).join('');

        } catch(e) { console.error(e); }
    }

    // --- HELPER: Create Card HTML ---
    function createCard(item) {
        // Bersihkan URL/Slug untuk dikirim ke series.html
        // Donghua: butuh full url atau slug dari anichin
        // Anime: butuh slug (misal: one-piece)
        
        let slug = item.url;
        if(item.source === 'donghua') {
            // Ambil slug dari URL anichin jika bentuknya URL penuh
            if(slug.includes('anichin')) {
                // Biasanya URL anichin: .../nama-donghua/
                // Kita kirim full URL saja biar aman, karena series.html Anda handle donghua by URL
            }
        }

        const badgeColor = item.source === 'anime' ? 'bg-anime' : 'bg-donghua';
        
        return `
        <div class="card" onclick="window.location.href='series.html?slug=${encodeURIComponent(slug)}&source=${item.source}'">
            <span class="card-badge ${badgeColor}">${item.source.toUpperCase()}</span>
            <img src="${item.poster}" loading="lazy" alt="${item.title}">
            <p>${item.title}</p>
        </div>
        `;
    }

    // Init
    loadGenres();
    loadLatest();
    // Trigger klik tab pertama manual untuk load awal
    document.querySelector('.tab-btn').click();
    lucide.createIcons();
</script>
</body>
</html>
