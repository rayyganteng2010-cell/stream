<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayStream Home</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Cek Login
        if (!localStorage.getItem('user_info')) {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        /* CSS Tambahan untuk Badge Tipe (Anime/Donghua) */
        .type-badge {
            position: absolute; top: 8px; left: 8px;
            padding: 3px 8px; border-radius: 6px;
            font-size: 0.65rem; font-weight: 700; z-index: 5;
            text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .bg-donghua { background: rgba(59, 130, 246, 0.9); color: white; } /* Biru */
        .bg-anime { background: rgba(245, 158, 11, 0.9); color: black; }   /* Kuning/Orange */
    </style>
</head>
<body>

<header>
    <div class="logo">RayStream</div>
    <div id="userStatus"></div>
</header>

<div class="slider-container" style="display:flex; overflow-x:auto; gap:15px; padding:20px; scrollbar-width:none;">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/475ede11cdfbde3a0ed41aceeadbd3ce%20(1).jpg" class="slider-img">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/ec12a7175835f59a38e9a2082bc47b29.jpg" class="slider-img">
    <img src="https://raw.githubusercontent.com/rayyganteng2010-cell/ice-gpt/refs/heads/main/0c96d013d87134ba7d2c951a889ebf15.jpg" class="slider-img">
</div>

<div class="container">
    <div class="section-header">
        <h3>Popular Donghua</h3>
    </div>
    <div id="popularData" class="grid">
        <p style="color:#555;">Loading...</p>
    </div>

    <div class="section-header">
        <h3>Latest Release</h3>
        <span id="pageIndicator" style="font-size:0.8rem; color:#666;">Page 1</span>
    </div>
    
    <div id="latestData" class="grid">
        </div>

    <button id="btnLoadMore" class="btn-load-more" onclick="loadNextPage()">
        Load Next Page
    </button>
</div>

<nav class="bottom-nav">
    <a href="index.html" class="nav-item active"><i data-lucide="home"></i></a>
    <a href="schedule.html" class="nav-item"><i data-lucide="calendar"></i></a>
    <a href="history.html" class="nav-item"><i data-lucide="history"></i></a>
</nav>

<script>
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    const API_ANIME = "https://www.sankavollerei.com/anime/samehadaku/home";

    // LOGIC PAGE ROTATION
    let storedPage = parseInt(localStorage.getItem('current_page')) || 0; 
    let currentPage = storedPage + 1;
    if (currentPage > 5) currentPage = 1; 
    localStorage.setItem('current_page', currentPage);

    document.getElementById('pageIndicator').innerText = `Page ${currentPage}`;

    // Helper: Slug Cleaner untuk Anichin
    function getCleanSlug(href) {
        if (!href) return '';
        href = href.replace(/\/$/, '');
        let segment = href.substring(href.lastIndexOf('/') + 1);
        return segment.replace(/-episode-\d+.*$/i, '');
    }

    // 1. Load Popular (Donghua)
    async function loadPopular() {
        try {
            const res = await fetch(`${API_DONGHUA}/popular`);
            const data = await res.json();
            document.getElementById('popularData').innerHTML = data.data.slice(0, 6).map(item => `
                <div class="card" onclick="window.location.href='series.html?slug=${getCleanSlug(item.href)}&type=donghua'">
                    <span class="type-badge bg-donghua">Donghua</span>
                    <img src="${item.poster}" loading="lazy">
                    <p>${item.title}</p>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    // 2. Load Mixed Content (Anime + Donghua)
    async function loadMixedContent(pageNum) {
        const btn = document.getElementById('btnLoadMore');
        btn.innerText = "Loading...";

        try {
            // Kita buat array janji (Promises)
            const promises = [
                fetch(`${API_DONGHUA}/list?page=${pageNum}`).then(r => r.json())
            ];

            // HANYA ambil Anime di load pertama kali (biar gak duplikat terus saat next page)
            // Atau kalau mau selalu refresh anime, biarkan fetch terus. 
            // Di sini saya setting fetch Anime setiap load biar up to date.
            promises.push(fetch(API_ANIME).then(r => r.json()));

            const [dataDonghua, dataAnime] = await Promise.all(promises);

            // --- NORMALISASI DATA (Biar formatnya sama) ---

            // A. Proses Anime (Samehadaku)
            let animeList = [];
            if (dataAnime && dataAnime.data && dataAnime.data.recent && dataAnime.data.recent.animeList) {
                animeList = dataAnime.data.recent.animeList.map(item => ({
                    title: item.title,
                    poster: item.poster,
                    ep: item.episodes,
                    // AnimeId dari Samehadaku biasanya bersih, kita pakai sebagai slug
                    slug: item.animeId, 
                    type: 'anime', // Penanda
                    rawDate: item.releasedOn
                }));
            }

            // B. Proses Donghua (Anichin)
            let donghuaList = [];
            if (dataDonghua && dataDonghua.data) {
                donghuaList = dataDonghua.data.map(item => ({
                    title: item.title,
                    poster: item.poster,
                    ep: '?', // Anichin list kadang gak ada ep number di endpoint ini
                    slug: getCleanSlug(item.href),
                    type: 'donghua',
                    rawDate: 'Just now'
                }));
            }

            // --- PENGGABUNGAN ---
            // Kita selang-seling (interleave) atau gabung langsung.
            // Karena Anime biasanya lebih dikit updatenya per hari dibanding donghua,
            // Kita taruh Anime di sela-sela atau di atas.
            
            // Strategi: Gabung semua -> Randomize dikit biar variatif -> Render
            let combined = [...animeList, ...donghuaList];

            // (Optional) Shuffle array biar nyampur banget
            // combined.sort(() => Math.random() - 0.5); 

            // Append ke HTML
            const container = document.getElementById('latestData');
            
            const html = combined.map(item => {
                // Tentukan warna badge
                const badgeClass = item.type === 'anime' ? 'bg-anime' : 'bg-donghua';
                const label = item.type === 'anime' ? 'ANIME' : 'DONGHUA';
                
                // Link Hati-hati:
                // Kita oper parameter '&source=anime' biar nanti series.html tau harus fetch kemana
                // (Nanti lu harus update series.html buat handle source=anime)
                return `
                <div class="card" onclick="window.location.href='series.html?slug=${item.slug}&source=${item.type}'">
                    <span class="type-badge ${badgeClass}">${label}</span>
                    <img src="${item.poster}" loading="lazy">
                    <p>${item.title}</p>
                    <div style="position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); color:#fff; font-size:0.6rem; padding:2px 6px; border-radius:4px;">
                        Ep ${item.ep}
                    </div>
                </div>
                `;
            }).join('');

            // Kalau ini halaman pertama, replace isi. Kalau next page, append.
            // Tapi karena struktur logic loadNextPage append, kita pakai insertAdjacentHTML
            container.insertAdjacentHTML('beforeend', html);
            
            btn.innerText = "Load Next Page";

        } catch (e) { 
            console.error("Error loading content:", e);
            document.getElementById('btnLoadMore').innerText = "Try Again";
        }
    }

    // 3. Fungsi Tombol Next Page
    function loadNextPage() {
        currentPage++;
        // Saat next page, kita mungkin cuma mau load Donghua (karena anime listnya itu2 aja di endpoint recent)
        // Tapi di logic loadMixedContent diatas, dia fetch dua-duanya.
        // Gpp, biar user liat anime lagi kalau scroll bawah.
        loadMixedContent(currentPage);
    }

    // Tampilkan Avatar User
    const user = JSON.parse(localStorage.getItem('user_info'));
    if(user) {
        document.getElementById('userStatus').innerHTML = `
            <img src="${user.picture}" style="width:36px; height:36px; border-radius:50%; border:2px solid var(--primary); cursor:pointer;" onclick="window.location.href='history.html'">
        `;
    }

    // Init
    loadPopular();
    loadMixedContent(currentPage);
    lucide.createIcons();
</script>
</body>
</html>
