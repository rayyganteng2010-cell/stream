<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RayStream</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    // wajib login
    if (!localStorage.getItem('user_info')) window.location.href = 'login.html';
  </script>
</head>
<body>

<header class="rs-header">
  <div class="rs-brand" onclick="location.href='index.html'">
    <div class="rs-logo">RayStream</div>
    <div class="rs-sub">Anime + Donghua, disatuin biar otak kamu nggak perlu multitasking</div>
  </div>

  <div class="rs-actions">
    <div class="rs-search">
      <i data-lucide="search" class="rs-ico"></i>
      <input id="q" type="search" placeholder="Cari judul... (anime & donghua)" autocomplete="off" />
      <button id="btnClear" class="rs-clear" title="Clear" style="display:none;">
        <i data-lucide="x"></i>
      </button>
    </div>
  </div>
</header>

<div class="tabs-wrap">
  <button class="tab-btn active" data-tab="latest">
    <i data-lucide="sparkles"></i><span>Latest</span>
  </button>
  <button class="tab-btn" data-tab="ongoing">
    <i data-lucide="play-circle"></i><span>Ongoing</span>
  </button>
  <button class="tab-btn" data-tab="completed">
    <i data-lucide="check-circle-2"></i><span>Completed</span>
  </button>
</div>

<main class="container">
  <div class="panel rs-panel">
    <div class="rs-panel-head">
      <div class="rs-status" id="statusText">Memuat...</div>

      <div class="rs-pager">
        <button id="btnPrev" class="btn btn-ghost" disabled title="Prev">
          <i data-lucide="chevron-left"></i>
        </button>
        <div class="rs-page">Page <span id="pageNum">1</span></div>
        <button id="btnNext" class="btn btn-ghost" title="Next">
          <i data-lucide="chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- DONGHUA -->
    <section class="rs-section">
      <div class="rs-section-title">
        <div class="rs-pill rs-pill-donghua"><span>DONGHUA</span></div>
        <h3 id="titleDonghua">Donghua</h3>
      </div>
      <div id="gridDonghua" class="grid"></div>
      <div id="emptyDonghua" class="rs-empty" style="display:none;">Tidak ada data donghua.</div>
    </section>

    <!-- ANIME -->
    <section class="rs-section">
      <div class="rs-section-title">
        <div class="rs-pill rs-pill-anime"><span>ANIME</span></div>
        <h3 id="titleAnime">Anime</h3>
      </div>
      <div id="gridAnime" class="grid"></div>
      <div id="emptyAnime" class="rs-empty" style="display:none;">Tidak ada data anime.</div>
    </section>

    <div id="loading" class="rs-loading" style="display:none;">
      <div class="spinner"></div>
      <div>Loading...</div>
    </div>
  </div>
</main>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item active"><i data-lucide="home"></i></a>
  <a href="schedule.html" class="nav-item"><i data-lucide="calendar"></i></a>
  <a href="history.html" class="nav-item"><i data-lucide="history"></i></a>
  <a href="home.html" class="nav-item"><i data-lucide="layout-grid"></i></a>
</nav>

<script>
  const API_DONGHUA = "https://anichin-seven.vercel.app/api";
  const API_ANIME   = "https://donghua-qnha.vercel.app/anime/samehadaku";

  const ENDPOINT = {
    latest: {
      donghua: (page) => `${API_DONGHUA}/list?page=${page}`,
      anime:   (page) => `${API_ANIME}/home?page=${page}` // fallback handled
    },
    ongoing: {
      donghua: (page) => `${API_DONGHUA}/ongoing?page=${page}`,
      anime:   (page) => `${API_ANIME}/ongoing?page=${page}`
    },
    completed: {
      donghua: (page) => `${API_DONGHUA}/completed?page=${page}`,
      anime:   (page) => `${API_ANIME}/completed?page=${page}`
    },
    search: {
      donghua: (q) => `${API_DONGHUA}/search?s=${encodeURIComponent(q)}`,
      anime:   (q) => `${API_ANIME}/search?query=${encodeURIComponent(q)}`
    }
  };

  let state = { tab: "latest", page: 1, q: "" };

  const el = {
    q: document.getElementById("q"),
    btnClear: document.getElementById("btnClear"),
    loading: document.getElementById("loading"),
    status: document.getElementById("statusText"),
    pageNum: document.getElementById("pageNum"),
    btnPrev: document.getElementById("btnPrev"),
    btnNext: document.getElementById("btnNext"),
    gridD: document.getElementById("gridDonghua"),
    gridA: document.getElementById("gridAnime"),
    emptyD: document.getElementById("emptyDonghua"),
    emptyA: document.getElementById("emptyAnime"),
    titleD: document.getElementById("titleDonghua"),
    titleA: document.getElementById("titleAnime")
  };

  function setLoading(on){ el.loading.style.display = on ? "flex" : "none"; }
  function setEmpty(which, on){ (which === "donghua" ? el.emptyD : el.emptyA).style.display = on ? "block" : "none"; }

  function clearGrid(){
    el.gridD.innerHTML = "";
    el.gridA.innerHTML = "";
    setEmpty("donghua", false);
    setEmpty("anime", false);
  }

  function titleCase(s){ return (s || "").charAt(0).toUpperCase() + (s || "").slice(1); }

  function normalizeDonghua(json){
    const arr = json?.data;
    return Array.isArray(arr) ? arr : [];
  }

  function normalizeAnime(json){
    const a = json?.data?.animeList;
    if (Array.isArray(a)) return a;
    const b = json?.data;
    if (Array.isArray(b)) return b;
    return [];
  }

  function getAnimePagination(json){ return json?.pagination || null; }

  function renderCards(list, kind){
    const grid = (kind === "donghua") ? el.gridD : el.gridA;

    grid.innerHTML = list.map(item => {
      const title = (item.title || "").trim();
      const poster = item.poster || "";
      const status = (item.status || "").trim();
      const type = (item.type || "").trim();
      const score = (item.score || item.rating || "").toString().trim();
      const sub = (item.sub || "").trim();

      const slug = kind === "donghua"
        ? (item.slug || (item.anichinUrl ? item.anichinUrl.split('/').filter(Boolean).pop() : ""))
        : (item.animeId || "");

      const badgeClass = kind === "donghua" ? "tag-donghua" : "tag-anime";
      const badgeText  = kind === "donghua" ? "DONGHUA" : "ANIME";

      const left = status || type || "—";
      const right = score ? `⭐ ${score}` : (sub ? sub : "");

      const link = `series.html?slug=${encodeURIComponent(slug)}&source=${kind}`;

      return `
        <article class="card rs-card" onclick="window.location.href='${link}'">
          <span class="type-tag ${badgeClass}">${badgeText}</span>
          <img src="${poster}" loading="lazy" alt="${title}">
          <div class="card-info">
            <div class="card-title">${title}</div>
            <div class="card-ep">
              <span>${left}</span>
              <span>${right}</span>
            </div>
          </div>
        </article>
      `;
    }).join("");
  }

  async function fetchJson(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  async function load(){
    setLoading(true);
    clearGrid();

    const isSearch = state.q.length > 0;

    el.titleD.textContent = isSearch ? `Hasil Search: "${state.q}"` : `${titleCase(state.tab)} Donghua`;
    el.titleA.textContent = isSearch ? `Hasil Search: "${state.q}"` : `${titleCase(state.tab)} Anime`;

    el.pageNum.textContent = state.page;
    el.btnPrev.disabled = (state.page <= 1) || isSearch;

    el.status.textContent = isSearch
      ? `Mencari di 2 sumber...`
      : `Menampilkan ${titleCase(state.tab)} (2 sumber)`;

    try{
      const [jD, jA] = await Promise.all([
        isSearch
          ? fetchJson(ENDPOINT.search.donghua(state.q))
          : fetchJson(ENDPOINT[state.tab].donghua(state.page)),
        isSearch
          ? fetchJson(ENDPOINT.search.anime(state.q))
          : fetchJson(ENDPOINT[state.tab].anime(state.page))
            .catch(async () => {
              // fallback khusus latest anime
              if(state.tab !== "latest") throw new Error("anime endpoint fail");
              try { return await fetchJson(`${API_ANIME}/latest?page=${state.page}`); }
              catch { return await fetchJson(`${API_ANIME}/list?page=${state.page}`); }
            })
      ]);

      const donghuaList = normalizeDonghua(jD);
      const animeList = normalizeAnime(jA);

      if(donghuaList.length) renderCards(donghuaList, "donghua");
      else setEmpty("donghua", true);

      if(animeList.length) renderCards(animeList, "anime");
      else setEmpty("anime", true);

      if(isSearch){
        el.btnNext.disabled = true;
      } else {
        const pA = getAnimePagination(jA);
        const animeHasNext = (pA && typeof pA.hasNextPage === "boolean") ? pA.hasNextPage : true;
        const donghuaHasNext = donghuaList.length > 0;
        el.btnNext.disabled = !(animeHasNext || donghuaHasNext);
      }
    } catch(err){
      console.error(err);
      el.status.textContent = "Gagal load data. Cek console, atau API lagi drama.";
      setEmpty("donghua", true);
      setEmpty("anime", true);
      el.btnNext.disabled = true;
    } finally {
      setLoading(false);
      lucide.createIcons();
    }
  }

  // tabs
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      state.tab = btn.dataset.tab;
      state.page = 1;

      // keluar dari search kalau ganti tab
      if(state.q){
        state.q = "";
        el.q.value = "";
        el.btnClear.style.display = "none";
      }

      load();
    });
  });

  document.getElementById("btnPrev").addEventListener("click", () => {
    if(state.page <= 1) return;
    state.page--;
    load();
  });

  document.getElementById("btnNext").addEventListener("click", () => {
    state.page++;
    load();
  });

  // search debounce
  let tmr = null;
  el.q.addEventListener("input", () => {
    const v = el.q.value.trim();
    el.btnClear.style.display = v ? "flex" : "none";
    clearTimeout(tmr);
    tmr = setTimeout(() => {
      state.q = v;
      state.page = 1;
      load();
    }, 350);
  });

  el.btnClear.addEventListener("click", () => {
    el.q.value = "";
    el.btnClear.style.display = "none";
    state.q = "";
    state.page = 1;
    load();
  });

  load();
  lucide.createIcons();
</script>

</body>
    </html>
