<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail - RAYSTREAM</title>
    <style>
        :root { --bg: #050505; --card: #141414; --primary: #06b6d4; --text: #fff; }
        body { margin:0; font-family:'Segoe UI', sans-serif; background:var(--bg); color:var(--text); padding-bottom:60px; }

        /* PLAYER AREA */
        .player-box { position:sticky; top:0; width:100%; aspect-ratio:16/9; background:#000; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        iframe { width:100%; height:100%; border:none; }
        .fs-btn { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.6); padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer; color:#fff; backdrop-filter:blur(4px); }

        /* INFO & CONTENT */
        .box { padding:20px; }
        .main-title { font-size:18px; font-weight:800; margin-bottom:5px; line-height:1.3; text-shadow:0 2px 4px rgba(0,0,0,0.5); }
        .sub-info { color:#aaa; font-size:12px; margin-bottom:15px; font-weight:500; }
        .tag { display:inline-block; background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:4px; font-size:11px; margin-right:5px; border:1px solid rgba(255,255,255,0.1); }

        /* BUTTONS */
        .actions { display:flex; gap:10px; margin-bottom:20px; }
        .btn { flex:1; background:#222; border:1px solid #333; color:#fff; padding:12px; border-radius:10px; font-weight:700; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; transition:0.2s; }
        .btn:active { transform:scale(0.96); }
        .btn.hl { background:var(--primary); color:#000; border:none; box-shadow:0 0 15px rgba(6,182,212,0.2); }

        /* EPISODE GRID */
        .ep-sec { font-weight:700; margin-bottom:12px; font-size:14px; border-left:3px solid var(--primary); padding-left:10px; }
        .ep-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; }
        .ep-btn { background:var(--card); border:1px solid #222; color:#888; text-align:center; padding:12px 0; border-radius:8px; font-size:12px; text-decoration:none; font-weight:700; transition:0.2s; }
        .ep-btn:hover { background:#222; color:#fff; }
        .ep-btn.active { background:var(--primary); color:#000; border-color:var(--primary); box-shadow:0 4px 10px rgba(6,182,212,0.3); }

        /* DOWNLOAD MODAL */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:200; display:none; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(5px); }
        .modal.show { display:flex; }
        .modal-c { background:#151515; width:100%; max-width:400px; padding:25px; border-radius:20px; border:1px solid #333; max-height:80vh; overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.8); }
        .dl-row { margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:10px; }
        .dl-res { font-weight:800; color:var(--primary); font-size:14px; margin-bottom:8px; }
        .dl-a { display:inline-block; background:#222; color:#ccc; padding:6px 12px; border-radius:6px; margin:0 5px 5px 0; text-decoration:none; font-size:11px; border:1px solid #333; }

        .back-float { position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); padding:8px 12px; border-radius:50%; cursor:pointer; z-index:110; color:#fff; font-weight:bold; }
    </style>
</head>
<body>

<div id="app"></div>

<div id="dlModal" class="modal" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="modal-c" id="dlBody"></div>
</div>

<script src="config.js"></script>
<script>
    // Ambil URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const rawUrl = urlParams.get('url');

    async function init() {
        if(!rawUrl) return;
        document.getElementById('app').innerHTML = `<div style="text-align:center;padding:100px;color:#666;">Memuat Data...</div>`;

        // --- PROXY LOGIC ---
        // Kita ubah URL asli "https://www.sankavollerei.com/anime/donghua/..." 
        // Menjadi internal proxy "/sanka-api/..." agar tidak kena CORS
        let fetchUrl = rawUrl;
        if(rawUrl.includes('sankavollerei.com/anime/donghua')) {
            fetchUrl = rawUrl.replace('https://www.sankavollerei.com/anime/donghua', '/sanka-api');
        }

        try {
            const res = await fetch(fetchUrl);
            if(!res.ok) throw new Error("Gagal mengambil data");
            
            const json = await res.json();
            // Data biasanya dibungkus dalam 'data'
            const data = json.data || json; 

            // DETEKSI TIPE HALAMAN BERDASARKAN URL
            if (rawUrl.includes('/episode/')) {
                renderPlayer(data);
            } else {
                renderInfo(data);
            }
            
            saveHist(data, rawUrl);

        } catch(e) {
            console.error(e);
            document.getElementById('app').innerHTML = `<div style="text-align:center;padding:50px;color:#ef4444">Error: ${e.message}<br><small>Pastikan vercel.json sudah diupdate.</small></div>`;
        }
    }

    // --- RENDER HALAMAN NONTON (EPISODE) ---
    function renderPlayer(data) {
        // Cari Stream URL (Prioritas: main_url -> servers[0])
        let streamUrl = "";
        const streams = data.streaming || {};
        
        if (streams.main_url) streamUrl = streams.main_url.url;
        else if (streams.servers && streams.servers.length > 0) streamUrl = streams.servers[0].url;

        // List Episode (Sidebar/Bawah)
        const eps = data.episodes_list || [];
        let epHtml = "";
        eps.forEach(ep => {
            const num = formatEp(ep.episode || ep.title);
            // Reconstruct URL asli dari slug/href jika perlu, atau pakai anichinUrl kalau ada
            const link = ep.anichinUrl || ep.url;
            const isActive = link === rawUrl ? 'active' : '';
            
            if(link) {
                epHtml += `<a href="detail.html?url=${encodeURIComponent(link)}" class="ep-btn ${isActive}">${num}</a>`;
            }
        });

        // Simpan Download Data
        window.dlData = data.download_url;

        // Navigasi Prev/Next
        const nav = data.navigation || {};
        let navHtml = `
            ${nav.previous_episode ? `<a href="detail.html?url=${encodeURIComponent(nav.previous_episode.anichinUrl)}" class="btn">Prev</a>` : ''}
            <a href="index.html" class="btn">Home</a>
            ${nav.next_episode ? `<a href="detail.html?url=${encodeURIComponent(nav.next_episode.anichinUrl)}" class="btn">Next</a>` : ''}
        `;

        document.getElementById('app').innerHTML = `
            <div class="player-box" id="pArea">
                <div class="back-float" onclick="window.location.href='index.html'">⬅</div>
                <iframe src="${streamUrl}" allowfullscreen></iframe>
                <div class="fs-btn" onclick="toggleFS()">⛶ Fullscreen</div>
            </div>
            
            <div class="box">
                <div class="main-title">${data.title || data.episode || 'Episode'}</div>
                <div class="sub-info">RAYSTREAM • ${data.status || 'HD'}</div>
                
                <div class="actions">
                    <div class="btn hl" onclick="showDl()">⬇ Download</div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:20px;">${navHtml}</div>

                <div class="ep-sec">Daftar Episode</div>
                <div class="ep-grid">${epHtml}</div>
            </div>
        `;
    }

    // --- RENDER HALAMAN INFO (SERIES) ---
    function renderInfo(data) {
        // List Episode
        const eps = data.episodes_list || [];
        let epHtml = "";
        eps.forEach(ep => {
            const num = formatEp(ep.episode);
            const link = ep.anichinUrl || ep.url;
            if(link) {
                epHtml += `<a href="detail.html?url=${encodeURIComponent(link)}" class="ep-btn">${num}</a>`;
            }
        });

        // Genres
        let genres = "";
        if(data.genres) data.genres.forEach(g => genres += `<span class="tag">${g.name}</span>`);

        document.getElementById('app').innerHTML = `
            <div class="player-box" style="background:url('${data.poster}') center/cover;">
                <div class="back-float" onclick="window.location.href='index.html'">⬅</div>
                <div style="width:100%;height:100%;background:linear-gradient(to top, #050505, transparent);display:flex;align-items:end;padding:20px;">
                    <div class="main-title" style="text-shadow:0 4px 10px #000; font-size:24px;">${data.title}</div>
                </div>
            </div>
            <div class="box">
                <div class="sub-info" style="color:var(--primary);font-weight:bold;">${data.status} • ${data.type}</div>
                <div style="margin-bottom:15px;">${genres}</div>
                
                <p style="font-size:13px;color:#ccc;line-height:1.6;margin-top:0">${data.synopsis || 'Sinopsis tidak tersedia.'}</p>
                
                <div class="ep-sec">Semua Episode</div>
                <div class="ep-grid">${epHtml}</div>
            </div>
        `;
    }

    // --- MODAL DOWNLOAD ---
    function showDl() {
        const d = window.dlData;
        const b = document.getElementById('dlBody');
        b.innerHTML = "<h3 style='margin-top:0'>Download</h3>";
        
        if(!d) { b.innerHTML += "<p>Link tidak tersedia.</p>"; }
        else {
            // Parsing object download_url (flexible key check)
            for(const [key, val] of Object.entries(d)) {
                // Bersihkan key, misal "download_url_360p" jadi "360P"
                const resName = key.replace(/download_url_/i, '').replace(/_/g, ' ').toUpperCase(); 
                
                let links = "";
                // Val bisa berupa object { "Gdrive": "url" }
                if(typeof val === 'object') {
                    for(const [srv, url] of Object.entries(val)) {
                        links += `<a href="${url}" target="_blank" class="dl-a">${srv}</a>`;
                    }
                }
                b.innerHTML += `<div class="dl-row"><div class="dl-res">${resName}</div>${links}</div>`;
            }
        }
        document.getElementById('dlModal').classList.add('show');
    }

    function toggleFS() {
        const el = document.getElementById('pArea');
        if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen();
    }

    function saveHist(data, url) {
        let h = JSON.parse(localStorage.getItem('ach_hist') || '[]');
        
        // Ambil data seadanya buat history
        const title = data.title || (data.donghua_details ? data.donghua_details.title : 'Episode');
        const img = data.poster || (data.donghua_details ? data.donghua_details.poster : '');
        const ep = data.episode || '??';

        h = h.filter(x => x.url !== url);
        h.unshift({ title, poster: img, url, ep, date: new Date().toLocaleDateString() });
        
        if(h.length > 20) h.pop();
        localStorage.setItem('ach_hist', JSON.stringify(h));
    }

    init();
</script>
</body>
</html>
