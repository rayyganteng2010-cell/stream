<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAYSTREAM Player</title>
    <style>
        :root { --bg: #050505; --card: #141414; --primary: #06b6d4; --text: #fff; }
        body { margin:0; font-family:'Segoe UI', sans-serif; background:var(--bg); color:var(--text); padding-bottom:50px; }

        .player-area { position:sticky; top:0; width:100%; aspect-ratio:16/9; background:#000; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        iframe { width:100%; height:100%; border:none; }
        .fs-btn { position:absolute; bottom:15px; right:15px; background:rgba(0,0,0,0.6); color:#fff; padding:8px; border-radius:8px; cursor:pointer; }

        .content { padding:20px; }
        .title { font-size:20px; font-weight:800; margin-bottom:8px; line-height:1.3; color:#fff; }
        .meta { color:#888; font-size:12px; margin-bottom:20px; font-weight:500; }
        
        .actions { display:flex; gap:12px; margin-bottom:25px; }
        .act-btn { flex:1; background:#1a1a1a; color:#fff; border:1px solid #333; padding:12px; border-radius:10px; text-align:center; font-size:13px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:0.2s; }
        .act-btn:active { transform:scale(0.96); background:#222; }
        .act-btn.primary { background:var(--primary); color:#000; border:none; }

        .ep-title { font-size:16px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
        .ep-list { display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; scrollbar-width:none; }
        .ep-list::-webkit-scrollbar { display:none; }
        .ep-box { flex-shrink:0; width:55px; height:50px; background:var(--card); border:1px solid #333; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:15px; font-weight:700; color:#888; cursor:pointer; text-decoration:none; transition:0.2s; }
        .ep-box.active { background:var(--primary); color:#000; border-color:var(--primary); box-shadow:0 0 15px rgba(6, 182, 212, 0.4); }

        .back-float { position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); padding:10px; border-radius:50%; cursor:pointer; z-index:110; color:#fff; transition:0.2s; }
        .back-float:active { transform:scale(0.9); }
        
        /* Modal Style */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:200; display:none; align-items:center; justify-content:center; padding:20px; }
        .modal.show { display:flex; }
        .modal-box { background:#1a1a1a; width:100%; max-width:400px; padding:25px; border-radius:20px; border:1px solid #333; max-height:80vh; overflow-y:auto; }
        .dl-res { margin-bottom:10px; font-size:13px; font-weight:bold; color:var(--primary); border-bottom:1px solid #333; padding-bottom:5px; }
        .dl-links a { display:block; background:#222; color:#fff; padding:10px; border-radius:8px; margin-bottom:8px; text-decoration:none; font-size:12px; border:1px solid #333; text-align:center; }
    </style>
</head>
<body>

<div id="app"></div>

<div id="dlModal" class="modal" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="modal-box" id="dlContent"></div>
</div>

<script src="config.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get('url');

    async function init() {
        if(!targetUrl) return;
        document.getElementById('app').innerHTML = `<div style="text-align:center;padding:100px;color:#666;">Memuat RAYSTREAM...</div>`;

        try {
            const res = await fetch(API_BASE + '/api/detail?url=' + encodeURIComponent(targetUrl));
            const data = await res.json();
            
            if(data.streaming || data.stream_url) {
                renderPlayer(data);
            } else {
                renderInfo(data);
            }
            saveHist(data);
        } catch(e) { console.error(e); }
    }

    function renderPlayer(data) {
        const stream = data.stream_url || data.streaming.url;
        const eps = data.episodes_list || [];
        
        let epHtml = "";
        eps.forEach(ep => {
            const num = formatEp(ep.title);
            const isActive = ep.url === targetUrl ? 'active' : '';
            epHtml += `<a href="detail.html?url=${encodeURIComponent(ep.url)}" class="ep-box ${isActive}">${num}</a>`;
        });

        document.getElementById('app').innerHTML = `
            <div class="player-area" id="pArea">
                <div class="back-float" onclick="window.location.href='index.html'">‚¨Ö</div>
                <iframe src="${stream}" allowfullscreen></iframe>
                <div class="fs-btn" onclick="toggleFS()">‚õ∂</div>
            </div>
            
            <div class="content">
                <div class="title">${data.title}</div>
                <div class="meta">RAYSTREAM ‚Ä¢ Free Streaming</div>

                <div class="actions">
                    <div class="act-btn primary" onclick="showDl()">
                        ‚¨á Download
                    </div>
                    <div class="act-btn" onclick="window.location.href='index.html'">
                        üè† Home
                    </div>
                </div>

                <div class="ep-title">
                    Episode List
                    <span style="font-size:12px; font-weight:normal; color:#666">${eps.length} Eps</span>
                </div>
                <div class="ep-list">${epHtml}</div>
            </div>
        `;
        
        // Render Download Modal Data (Dummy/Real Logic)
        const dlBox = document.getElementById('dlContent');
        dlBox.innerHTML = "<h3 style='margin-top:0'>Download</h3>";
        if(data.download_url) {
             // Logic parsing download here if needed
             dlBox.innerHTML += `<p>Link download tersedia.</p>`;
        } else {
            dlBox.innerHTML += `<p style='color:#666'>Link belum tersedia.</p>`;
        }
    }

    function renderInfo(data) {
        const eps = data.episodes || [];
        let epHtml = "";
        eps.forEach(ep => {
            const num = formatEp(ep.title);
            epHtml += `<a href="detail.html?url=${encodeURIComponent(ep.url)}" class="ep-box">${num}</a>`;
        });

        document.getElementById('app').innerHTML = `
            <div class="player-area" style="background:url('${data.thumbnail}') center/cover;">
                <div class="back-float" onclick="window.history.back()">‚¨Ö</div>
                <div style="width:100%;height:100%;background:linear-gradient(to top, #050505, transparent);display:flex;align-items:end;padding:20px;">
                    <h1 style="margin:0;font-size:24px;text-shadow:0 4px 10px rgba(0,0,0,0.8);">${data.title}</h1>
                </div>
            </div>
            <div class="content">
                <div class="meta" style="color:var(--primary); font-weight:bold;">${data.status} ‚Ä¢ ${data.type}</div>
                <p style="font-size:14px;color:#ccc;line-height:1.6;margin-top:0;">${data.synopsis}</p>
                <div class="ep-title">All Episodes</div>
                <div class="ep-list" style="flex-wrap:wrap; overflow:visible;">${epHtml}</div>
            </div>
        `;
    }

    function toggleFS() {
        const el = document.getElementById('pArea');
        if(!document.fullscreenElement) el.requestFullscreen();
        else document.exitFullscreen();
    }
    function showDl() { document.getElementById('dlModal').classList.add('show'); }
    
    function saveHist(data) {
        let h = JSON.parse(localStorage.getItem('ach_hist') || '[]');
        h = h.filter(x => x.url !== targetUrl);
        h.unshift({ title: data.title, thumbnail: data.thumbnail, url: targetUrl, ep: data.episode || '?', date: new Date().toLocaleDateString() });
        if(h.length>20) h.pop();
        localStorage.setItem('ach_hist', JSON.stringify(h));
    }
    init();
</script>
</body>
</html>
