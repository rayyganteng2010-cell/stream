<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail</title>
    <style>
        :root { --bg: #050505; --card: #141414; --primary: #06b6d4; --text: #fff; }
        body { margin:0; font-family:'Segoe UI', sans-serif; background:var(--bg); color:var(--text); padding-bottom:60px; }

        /* PLAYER */
        .player-box { position:sticky; top:0; width:100%; aspect-ratio:16/9; background:#000; z-index:100; }
        iframe { width:100%; height:100%; border:none; }
        .fs-btn { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.6); padding:5px 8px; border-radius:4px; font-size:11px; cursor:pointer; }

        /* INFO */
        .box { padding:20px; }
        .main-title { font-size:18px; font-weight:800; margin-bottom:5px; line-height:1.3; }
        .sub-info { color:#888; font-size:12px; margin-bottom:15px; }
        .tag { background:#222; padding:2px 8px; border-radius:4px; font-size:11px; margin-right:5px; border:1px solid #333; }

        /* ACTIONS */
        .actions { display:flex; gap:10px; margin-bottom:20px; }
        .btn { flex:1; background:#222; border:1px solid #333; color:#fff; padding:10px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:5px; }
        .btn.hl { background:var(--primary); color:#000; border:none; }

        /* EPISODES */
        .ep-sec { font-weight:700; margin-bottom:10px; font-size:14px; }
        .ep-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; }
        .ep-btn { background:var(--card); border:1px solid #333; color:#aaa; text-align:center; padding:10px 0; border-radius:6px; font-size:12px; text-decoration:none; font-weight:600; display:block; }
        .ep-btn.active { background:var(--primary); color:#000; border-color:var(--primary); }

        /* NAV PREV/NEXT */
        .nav-eps { display:flex; gap:10px; margin-bottom:20px; }

        /* DOWNLOAD MODAL */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:200; display:none; align-items:center; justify-content:center; padding:20px; }
        .modal.show { display:flex; }
        .modal-c { background:#1a1a1a; width:100%; max-width:400px; padding:20px; border-radius:15px; border:1px solid #333; max-height:80vh; overflow-y:auto; }
        .dl-grp { margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px; }
        .dl-res { font-weight:bold; color:var(--primary); font-size:13px; margin-bottom:5px; }
        .dl-a { display:inline-block; background:#333; color:#fff; padding:6px 12px; border-radius:6px; margin:0 5px 5px 0; text-decoration:none; font-size:11px; }

        .back { position:absolute; top:15px; left:15px; background:rgba(0,0,0,0.6); width:35px; height:35px; display:flex; align-items:center; justify-content:center; border-radius:50%; cursor:pointer; z-index:110; }
    </style>
</head>
<body>

<div id="app"></div>

<div id="dlModal" class="modal" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="modal-c" id="dlBody"></div>
</div>

<script src="config.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get('url');

    async function init() {
        if(!targetUrl) return;
        document.getElementById('app').innerHTML = `<div style="text-align:center;padding:100px;color:#666;">Memuat...</div>`;

        const data = await fetchAPI('/api/detail?url=' + encodeURIComponent(targetUrl));
        
        if(!data) {
            document.getElementById('app').innerHTML = "Gagal memuat data.";
            return;
        }

        // DETEKSI TIPE HALAMAN
        // Jika ada 'streaming' (object) -> Halaman Nonton
        // Jika ada 'genres' (array) -> Halaman Info Series
        
        if (data.streaming || data.stream_url) {
            renderWatch(data);
        } else {
            renderInfo(data);
        }
    }

    // --- RENDER HALAMAN NONTON ---
    function renderWatch(data) {
        // Ambil URL Stream (Utamakan main_url)
        let streamUrl = "";
        if(data.streaming) {
            streamUrl = data.streaming.main_url ? data.streaming.main_url.url : "";
            if(!streamUrl && data.streaming.servers && data.streaming.servers.length) {
                streamUrl = data.streaming.servers[0].url;
            }
        }

        // List Episode (Sidebar)
        let epHtml = "";
        if(data.episodes_list) {
            data.episodes_list.forEach(ep => {
                const isActive = ep.anichinUrl === targetUrl ? 'active' : '';
                epHtml += `<a href="detail.html?url=${encodeURIComponent(ep.anichinUrl)}" class="ep-btn ${isActive}">${formatEp(ep.episode)}</a>`;
            });
        }

        // Navigation (Prev/Next)
        const nav = data.navigation || {};
        let navHtml = `
            ${nav.previous_episode ? `<a href="detail.html?url=${encodeURIComponent(nav.previous_episode.anichinUrl)}" class="btn">Prev</a>` : ''}
            <a href="index.html" class="btn">All</a>
            ${nav.next_episode ? `<a href="detail.html?url=${encodeURIComponent(nav.next_episode.anichinUrl)}" class="btn">Next</a>` : ''}
        `;

        // Simpan Data Download ke Global Var buat Modal
        window.dlData = data.download_url;

        document.getElementById('app').innerHTML = `
            <div class="player-box" id="pArea">
                <div class="back" onclick="window.history.back()">⬅</div>
                <iframe src="${streamUrl}" allowfullscreen></iframe>
                <div class="fs-btn" onclick="toggleFS()">⛶ Fullscreen</div>
            </div>
            <div class="box">
                <div class="main-title">${data.episode || 'Episode'}</div>
                <div class="sub-info">RAYSTREAM • ${data.status || 'Success'}</div>
                
                <div class="actions">
                    <div class="btn hl" onclick="showDl()">⬇ Download</div>
                </div>

                <div class="nav-eps">${navHtml}</div>

                <div class="ep-sec">Daftar Episode</div>
                <div class="ep-grid">${epHtml}</div>
            </div>
        `;
    }

    // --- RENDER HALAMAN INFO SERIES ---
    function renderInfo(data) {
        let epHtml = "";
        if(data.episodes_list) {
            data.episodes_list.forEach(ep => {
                epHtml += `<a href="detail.html?url=${encodeURIComponent(ep.anichinUrl)}" class="ep-btn">${formatEp(ep.episode)}</a>`;
            });
        }

        let tags = "";
        if(data.genres) data.genres.forEach(g => tags += `<span class="tag">${g.name}</span>`);

        document.getElementById('app').innerHTML = `
            <div class="player-box" style="background:url('${data.poster}') center/cover;">
                <div class="back" onclick="window.history.back()">⬅</div>
                <div style="width:100%;height:100%;background:linear-gradient(to top, #050505, transparent);display:flex;align-items:end;padding:20px;">
                    <div class="main-title" style="text-shadow:0 2px 10px #000;">${data.title}</div>
                </div>
            </div>
            <div class="box">
                <div class="sub-info" style="color:var(--primary);font-weight:bold;">${data.status} • ${data.type}</div>
                <div style="margin-bottom:15px;">${tags}</div>
                <p style="font-size:13px;color:#ccc;line-height:1.6;margin-top:0">${data.synopsis}</p>
                
                <div class="ep-sec">Semua Episode</div>
                <div class="ep-grid">${epHtml}</div>
            </div>
        `;
    }

    function showDl() {
        const d = window.dlData;
        const b = document.getElementById('dlBody');
        b.innerHTML = "<h3 style='margin-top:0'>Download</h3>";
        
        if(!d) { b.innerHTML += "Link tidak tersedia."; }
        else {
            // Parsing object download_url (key: "download_url_360p", val: {server: link})
            for(const [k, servers] of Object.entries(d)) {
                // Ambil "360p" dari "download_url_360p"
                const resName = k.split('_').pop().toUpperCase(); 
                let links = "";
                for(const [srv, url] of Object.entries(servers)) {
                    links += `<a href="${url}" target="_blank" class="dl-a">${srv}</a>`;
                }
                b.innerHTML += `<div class="dl-grp"><div class="dl-res">${resName}</div>${links}</div>`;
            }
        }
        document.getElementById('dlModal').classList.add('show');
    }

    function toggleFS() {
        const el = document.getElementById('pArea');
        if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen();
    }

    init();
</script>
</body>
</html>
