<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>RayStream - Detail</title>
  <link rel="stylesheet" href="/ui.css">
</head>
<body>
  <div class="container">
    <div style="padding:14px 14px 10px; display:flex; align-items:center; gap:10px;">
      <a href="/" style="font-weight:900; font-size:18px;">←</a>
      <div id="titleTop" style="font-weight:900; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
    </div>

    <div class="videoWrap" id="topMedia" style="display:none;">
      <iframe id="topFrame" allowfullscreen></iframe>
    </div>

    <div class="hero" id="heroBox" style="margin-top:10px;">
      <img id="poster" src="" alt="">
      <div class="overlay"></div>
      <div class="content">
        <div class="title" id="title">Loading...</div>
        <div class="sub" id="sub"></div>

        <div class="badgeRow" id="badges"></div>

        <div class="btnRow">
          <button class="btn" id="btnWatch">Tonton Sekarang</button>
          <button class="btn primary" id="btnSub">Subscribe</button>
        </div>
      </div>
    </div>

    <div class="sectionTitle" id="epTitle">Episode List</div>
    <div class="pills" id="epPills"></div>

    <div class="sectionTitle">Recommended</div>
    <div class="grid3" id="recGrid"></div>

    <div class="sectionTitle">Sinopsis</div>
    <div class="card" style="margin:0 14px; padding:14px;">
      <div id="syn" style="color:var(--muted); font-size:13px; line-height:1.55;"></div>
    </div>

    <div class="err" id="err"></div>
  </div>

  <div class="bottomNav">
    <div class="row">
      <a class="navItem" href="/"><div class="navDot"></div><div>Home</div></a>
      <a class="navItem" href="/jadwal"><div class="navDot"></div><div>Jadwal</div></a>
      <a class="navItem" href="/riwayat"><div class="navDot"></div><div>Riwayat</div></a>
    </div>
  </div>

  <script src="/config.js"></script>
  <script>
    const el = (id)=>document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const animeId = params.get("id");
    const searchQ = params.get("search");

    function posterCard(it){
      return `
        <div class="posterCard" data-id="${esc(it.animeId||"")}">
          <img src="${esc(it.poster||"")}" alt="">
          <div class="pbody">
            <div class="ptitle">${esc(it.title||"")}</div>
            <div class="pmeta">
              <span>${esc(it.type||it.episodes||"")}</span>
              <span>${esc(it.score||"")}</span>
            </div>
          </div>
        </div>
      `;
    }

    function bindPosterCards(root){
      root.querySelectorAll(".posterCard").forEach(c=>{
        c.onclick = ()=> {
          const id = c.getAttribute("data-id");
          if(id) location.href = `/detail?id=${encodeURIComponent(id)}`;
        };
      });
    }

    async function loadSearch(){
      el("titleTop").innerText = "Search";
      el("title").innerText = `Hasil: ${searchQ}`;
      el("sub").innerText = "";
      el("badges").innerHTML = `<span class="badge dim">search</span>`;
      el("btnWatch").style.display = "none";
      el("btnSub").style.display = "none";
      el("epTitle").innerText = "Result";
      el("epPills").style.display = "none";
      el("syn").innerText = "";

      const r = await fetch(`${API_BASE}/anime/samehadaku/search?query=${encodeURIComponent(searchQ)}`);
      const j = await r.json();
      if(!r.ok || j.status!=="success") throw new Error(j.message || "API error");

      const list = j?.data?.animeList || [];
      el("recGrid").innerHTML = list.slice(0, 24).map(posterCard).join("");
      bindPosterCards(el("recGrid"));
    }

    async function loadDetail(){
      const r = await fetch(`${API_BASE}/anime/samehadaku/anime/${encodeURIComponent(animeId)}`);
      const j = await r.json();
      if(!r.ok || j.status!=="success") throw new Error(j.message || "API error");

      const d = j.data || {};
      el("titleTop").innerText = d.title || animeId;
      el("title").innerText = d.title || animeId;
      el("poster").src = d.poster || "";
      el("sub").innerText = `${d.status || ""} • ${d.type || ""} • ${d.season || ""}`.replace(/\s•\s•\s/g," • ").trim();

      // badges kayak screenshot
      const badges = [];
      badges.push(`<span class="badge dim">donghua</span>`);
      if(d.status) badges.push(`<span class="badge dim">${esc(d.status.toLowerCase())}</span>`);
      if(d.season) badges.push(`<span class="badge dim">${esc(d.season.match(/\d{4}/)?.[0] || d.season)}</span>`);
      (d.genreList || []).slice(0,6).forEach(g=> badges.push(`<span class="badge">${esc(g.title||"")}</span>`));
      el("badges").innerHTML = badges.join("");

      // synopsis paragraphs
      const paras = d?.synopsis?.paragraphs || [];
      el("syn").innerText = paras.length ? paras.join("\n\n") : "-";

      // episode pills: ambil 20 episode terbaru (paling atas di response biasanya descending)
      const eps = d.episodeList || [];
      const pillsWrap = el("epPills");
      pillsWrap.innerHTML = "";
      eps.slice(0, 20).forEach((ep, idx)=>{
        const p = document.createElement("div");
        p.className = "pill" + (idx===0 ? " active" : "");
        p.innerText = ep.title;
        p.onclick = ()=> location.href = `/episode?id=${encodeURIComponent(ep.episodeId)}`;
        pillsWrap.appendChild(p);
      });

      // tombol "Tonton Sekarang" ke episode pertama di list
      el("btnWatch").onclick = ()=>{
        const first = eps[0];
        if(first?.episodeId) location.href = `/episode?id=${encodeURIComponent(first.episodeId)}`;
      };
      el("btnSub").onclick = ()=> {
        // dummy subscribe, kalau mau: simpan ke localStorage
        alert("Subscribe disimpen lokal dulu. Kalau mau beneran, bikin endpoint sendiri.");
      };

      // Recommended: pakai home.movie/recent sebagai rekomendasi quick (biar UI ada)
      // Kalau kamu punya endpoint rekomendasi khusus, ganti ini.
      try{
        const rh = await fetch(`${API_BASE}/anime/samehadaku/home`);
        const hj = await rh.json();
        const rec = (hj?.data?.movie?.animeList || hj?.data?.recent?.animeList || []).slice(0, 6);
        el("recGrid").innerHTML = rec.map(x=>posterCard(x)).join("");
        bindPosterCards(el("recGrid"));
      }catch(e){}
    }

    (async ()=>{
      el("err").innerText = "";
      try{
        if(searchQ) return await loadSearch();
        if(!animeId) throw new Error("anime id kosong");
        await loadDetail();
      }catch(e){
        el("err").innerText = "Gagal load detail: " + (e?.message || e);
      }
    })();
  </script>
</body>
</html>
