<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail</title>
    <style>
        :root { --bg: #050505; --card: #141414; --primary: #06b6d4; --text: #fff; }
        body { margin:0; font-family:'Segoe UI', sans-serif; background:var(--bg); color:var(--text); padding-bottom:60px; }

        /* PLAYER */
        .player-box { position:sticky; top:0; width:100%; aspect-ratio:16/9; background:#000; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        iframe { width:100%; height:100%; border:none; }
        .fs-btn { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.5); color:#fff; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; }

        /* INFO */
        .container { padding:20px; }
        .title { font-size:20px; font-weight:800; line-height:1.2; margin-bottom:5px; }
        .meta { color:#888; font-size:12px; margin-bottom:15px; }
        .genre-pill { display:inline-block; background:rgba(255,255,255,0.1); font-size:10px; padding:3px 8px; border-radius:4px; margin-right:5px; }

        /* ACTIONS */
        .actions { display:flex; gap:10px; margin-bottom:25px; }
        .btn { flex:1; background:#222; color:#fff; border:1px solid #333; padding:12px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:5px; }
        .btn.primary { background:var(--primary); color:#000; border:none; }

        /* EPISODE LIST */
        .ep-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; margin-top:10px; }
        .ep-btn { background:var(--card); border:1px solid #333; color:#aaa; text-align:center; padding:10px 0; border-radius:6px; font-size:13px; text-decoration:none; font-weight:600; }
        .ep-btn.active { background:var(--primary); color:#000; border-color:var(--primary); }

        /* MODAL DOWNLOAD */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:200; display:none; align-items:center; justify-content:center; padding:20px; }
        .modal.show { display:flex; }
        .modal-box { background:#1a1a1a; width:100%; max-width:400px; padding:20px; border-radius:15px; border:1px solid #333; max-height:80vh; overflow-y:auto; }
        .dl-row { margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px; }
        .dl-res { font-weight:bold; color:var(--primary); margin-bottom:5px; font-size:14px; }
        .dl-link { display:inline-block; background:#333; color:#fff; padding:5px 10px; border-radius:5px; font-size:11px; margin-right:5px; text-decoration:none; margin-bottom:5px; }

        .back { position:absolute; top:15px; left:15px; background:rgba(0,0,0,0.6); width:35px; height:35px; display:flex; align-items:center; justify-content:center; border-radius:50%; cursor:pointer; z-index:110; color:#fff; }
    </style>
</head>
<body>

<div id="app"></div>

<div id="dlModal" class="modal" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="modal-box" id="dlContent"></div>
</div>

<script src="config.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get('url');

    async function init() {
        if(!targetUrl) return;
        document.getElementById('app').innerHTML = `<div style="text-align:center;padding:100px;color:#777;">Memuat Data...</div>`;

        try {
            const res = await fetch(API_BASE + '/api/detail?url=' + encodeURIComponent(targetUrl));
            const data = await res.json();

            // DETEKSI TIPE: Episode (Nonton) atau Series (Info)
            // Episode biasanya punya key 'streaming' atau 'episode'
            // Series punya key 'genres' array
            
            if (data.streaming || data.episode) {
                renderPlayer(data);
            } else {
                renderSeries(data);
            }
            
            saveHist(data);

        } catch(e) { console.error(e); }
    }

    // --- MODE NONTON ---
    function renderPlayer(data) {
        // Ambil Streaming URL (Main atau Server)
        let streamUrl = "";
        if (data.streaming) {
            if (data.streaming.main_url) streamUrl = data.streaming.main_url.url;
            else if (data.streaming.servers && data.streaming.servers.length > 0) streamUrl = data.streaming.servers[0].url;
        }

        // List Episode Sidebar
        const eps = data.episodes_list || [];
        let epHtml = "";
        eps.forEach(ep => {
            const num = formatEp(ep.episode || ep.title);
            // Cek URL aktif
            const isActive = ep.anichinUrl === targetUrl ? 'active' : '';
            epHtml += `<a href="detail.html?url=${encodeURIComponent(ep.anichinUrl)}" class="ep-btn ${isActive}">${num}</a>`;
        });

        // Setup Download Logic
        window.currentDl = data.download_url; // Simpan di global buat modal

        document.getElementById('app').innerHTML = `
            <div class="player-box" id="pArea">
                <div class="back" onclick="window.location.href='index.html'">‚¨Ö</div>
                <iframe src="${streamUrl}" allowfullscreen></iframe>
                <div class="fs-btn" onclick="toggleFS()">‚õ∂ Fullscreen</div>
            </div>
            <div class="container">
                <div class="title">${data.episode || 'Episode Title'}</div>
                <div class="meta">RAYSTREAM ‚Ä¢ Free Access</div>
                
                <div class="actions">
                    <div class="btn primary" onclick="showDl()">‚¨á Download</div>
                    <div class="btn" onclick="window.location.href='index.html'">üè† Home</div>
                </div>

                <div style="font-weight:bold; margin-bottom:5px;">Episode List</div>
                <div class="ep-grid">${epHtml}</div>
            </div>
        `;
    }

    // --- MODE INFO SERIES ---
    function renderSeries(data) {
        const eps = data.episodes_list || [];
        let epHtml = "";
        eps.forEach(ep => {
            const num = formatEp(ep.episode);
            epHtml += `<a href="detail.html?url=${encodeURIComponent(ep.anichinUrl)}" class="ep-btn">${num}</a>`;
        });

        let genres = "";
        if(data.genres) data.genres.forEach(g => genres += `<span class="genre-pill">${g.name}</span>`);

        document.getElementById('app').innerHTML = `
            <div class="player-box" style="background:url('${data.poster}') center/cover;">
                <div class="back" onclick="window.location.href='index.html'">‚¨Ö</div>
                <div style="width:100%;height:100%;background:linear-gradient(to top, #050505, transparent);display:flex;align-items:end;padding:20px;">
                    <div class="title">${data.title}</div>
                </div>
            </div>
            <div class="container">
                <div class="meta" style="color:var(--primary);font-weight:bold;">${data.status} ‚Ä¢ ${data.type}</div>
                <div style="margin-bottom:15px;">${genres}</div>
                <p style="font-size:13px;color:#ccc;line-height:1.6;">${data.synopsis}</p>
                <div style="font-weight:bold; margin-bottom:5px;">All Episodes</div>
                <div class="ep-grid">${epHtml}</div>
            </div>
        `;
    }

    // --- DOWNLOAD MODAL LOGIC ---
    function showDl() {
        const dlData = window.currentDl;
        const box = document.getElementById('dlContent');
        box.innerHTML = "<h3 style='margin-top:0'>Download Links</h3>";

        if (!dlData) {
            box.innerHTML += "<p>Download tidak tersedia.</p>";
        } else {
            // Parsing Objek Download (Format API: key=res, val={server: url})
            // Contoh: "download_url_360p": { "Gdrive": "..." }
            
            for (const [key, servers] of Object.entries(dlData)) {
                // Bersihkan key (misal "download_url_360p" -> "360p")
                const resName = key.replace('download_url_', '').toUpperCase();
                
                let links = "";
                for (const [serverName, url] of Object.entries(servers)) {
                    links += `<a href="${url}" target="_blank" class="dl-link">${serverName}</a>`;
                }

                box.innerHTML += `
                <div class="dl-row">
                    <div class="dl-res">${resName}</div>
                    <div>${links}</div>
                </div>`;
            }
        }
        document.getElementById('dlModal').classList.add('show');
    }

    function toggleFS() {
        const el = document.getElementById('pArea');
        if(!document.fullscreenElement) el.requestFullscreen();
        else document.exitFullscreen();
    }

    function saveHist(data) {
        let h = JSON.parse(localStorage.getItem('ach_hist') || '[]');
        // Gunakan poster untuk series, atau thumbnail default
        let img = data.poster || (data.donghua_details ? data.donghua_details.poster : '');
        let title = data.title || (data.donghua_details ? data.donghua_details.title : 'Episode');

        // Filter duplicate
        h = h.filter(x => x.url !== targetUrl);
        h.unshift({ 
            title: title, 
            poster: img, 
            url: targetUrl, 
            date: new Date().toLocaleDateString() 
        });
        if(h.length>20) h.pop();
        localStorage.setItem('ach_hist', JSON.stringify(h));
    }

    init();
</script>
</body>
</html>
