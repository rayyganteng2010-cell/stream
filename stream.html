<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streaming - RayStream</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Menggunakan variabel CSS global agar konsisten */
    :root {
      --bg-main: #0f172a;
      --bg-card: #1e293b;
      --bg-element: #334155;
      --primary: #3b82f6;      /* Donghua Blue */
      --warning: #f59e0b;      /* Anime Orange */
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --radius: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-main);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      padding-bottom: 40px;
    }

    /* --- HEADER --- */
    header {
      position: sticky; top: 0; z-index: 50;
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .logo {
      font-weight: 800; font-size: 1.2rem; letter-spacing: 1px;
      background: linear-gradient(90deg, #fff, #94a3b8);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    /* --- VIDEO PLAYER --- */
    .video-container {
      width: 100%; max-width: 1000px; margin: 0 auto;
      background: #000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .aspect-ratio {
      position: relative; width: 100%; padding-bottom: 56.25%; /* 16:9 */
    }
    .aspect-ratio iframe {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      border: none;
    }

    /* --- CONTENT AREA --- */
    .container { padding: 20px; max-width: 1000px; margin: 0 auto; }

    .meta-box {
      margin-bottom: 20px;
      display: flex; flex-direction: column; gap: 8px;
    }

    .ep-title {
      font-size: 1.1rem; font-weight: 700; line-height: 1.4;
      margin: 0; color: #fff;
    }

    .ep-badges { display: flex; gap: 8px; align-items: center; }
    .badge {
      font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 6px;
      text-transform: uppercase;
    }
    .badge-src { background: var(--primary); color: #fff; }
    .badge-date { background: rgba(255,255,255,0.1); color: var(--text-muted); }

    /* --- CONTROLS --- */
    .control-row {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        margin-bottom: 25px;
    }
    .btn {
        background: var(--bg-card); color: var(--text-main);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 12px; border-radius: var(--radius);
        font-weight: 600; font-size: 0.9rem; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 6px;
        transition: 0.2s;
    }
    .btn:active { transform: scale(0.96); background: var(--bg-element); }
    .btn-primary { background: var(--primary); border: none; }

    /* --- PANELS (Server & DL) --- */
    .panel {
        background: var(--bg-card); padding: 20px; border-radius: var(--radius);
        margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
    }
    .panel-header {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 15px; cursor: pointer;
    }
    .panel-title { 
        font-weight: 700; font-size: 0.9rem; color: var(--text-muted); 
        text-transform: uppercase; letter-spacing: 1px;
        display: flex; align-items: center; gap: 8px;
    }

    /* Server Grid */
    .server-group { margin-bottom: 15px; }
    .server-label { 
        font-size: 0.75rem; color: var(--primary); font-weight: 700; 
        margin-bottom: 8px; text-transform: uppercase;
    }
    .server-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .btn-server {
        padding: 8px 14px; background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
        color: #cbd5e1; font-size: 0.75rem; font-weight: 600; cursor: pointer;
        transition: 0.2s; min-width: 80px;
    }
    .btn-server:hover { background: rgba(255,255,255,0.1); }
    .btn-server.active { 
        background: var(--primary); color: white; border-color: var(--primary);
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
    }

    /* Download List */
    .dl-row { 
        background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px;
        margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05);
    }
    .dl-res { font-size: 0.8rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
    .dl-links { display: flex; flex-wrap: wrap; gap: 6px; }
    .btn-dl {
        background: var(--bg-element); padding: 4px 10px; border-radius: 4px;
        font-size: 0.7rem; color: #cbd5e1; text-decoration: none; border: 1px solid rgba(255,255,255,0.1);
    }

    /* Toast */
    #toast-container {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        z-index: 3000; width: 90%; max-width: 400px;
        pointer-events: none;
    }
    .toast {
        background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
        color: white; padding: 12px 20px; border-radius: 50px;
        margin-bottom: 10px; font-size: 0.85rem; font-weight: 600;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
        border: 1px solid rgba(255,255,255,0.1);
        animation: slideDown 0.3s ease;
    }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  </style>
</head>
<body>

<div id="toast-container"></div>

<header>
  <div onclick="history.back()" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
    <i data-lucide="arrow-left" style="color:var(--text-main); width:24px;"></i>
  </div>
  <div class="logo">STREAM</div>
  <div style="width:24px;"></div> </header>

<div class="video-container">
  <div class="aspect-ratio">
    <iframe id="iframePlayer" src="" allowfullscreen allow="autoplay"></iframe>
  </div>
</div>

<div class="container">

  <div class="meta-box">
    <h1 id="epTitle" class="ep-title">Memuat Video...</h1>
    <div class="ep-badges">
      <span id="badgeSrc" class="badge badge-src">SOURCE</span>
      <span class="badge badge-date" id="dateInfo">Updating...</span>
    </div>
  </div>

  <div class="control-row">
    <button id="btnPrev" class="btn" style="opacity: 0.5; pointer-events: none;">
        <i data-lucide="skip-back" size="18"></i> Prev
    </button>
    <button class="btn" onclick="goToSeries()">
        <i data-lucide="list" size="18"></i> Episodes
    </button>
    <button id="btnNext" class="btn btn-primary" style="opacity: 0.5; pointer-events: none;">
        Next <i data-lucide="skip-forward" size="18"></i>
    </button>
  </div>

  <div class="panel">
    <div class="panel-header">
        <div class="panel-title"><i data-lucide="server" size="18"></i> Ganti Server</div>
    </div>
    <div id="serverListContainer">
        <p style="font-size:0.8rem; color:var(--text-muted);">Memuat daftar server...</p>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header" onclick="toggleDl()">
        <div class="panel-title"><i data-lucide="download-cloud" size="18"></i> Link Download</div>
        <i data-lucide="chevron-down" id="dlIcon" size="18" style="transition:0.3s"></i>
    </div>
    <div id="dlContainer" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px;">
        </div>
  </div>

</div>

<script>
  // =========================
  // API CONFIG & PROXY
  // =========================
  const API_DONGHUA = "https://anichin-seven.vercel.app/api";
  const API_ANIME   = "https://www.sankavollerei.com/anime/samehadaku";

  // Proxy Helper untuk Anime
  async function smartFetch(url) {
    const proxies = [
        (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
        (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
    ];
    
    // Direct
    try { const res = await fetch(url); if(res.ok) return await res.json(); } catch(e){}
    // Proxy
    for (const p of proxies) {
        try { const res = await fetch(p(url)); if(res.ok) return await res.json(); } catch(e){}
    }
    throw new Error("Gagal koneksi server");
  }

  // =========================
  // INIT
  // =========================
  const urlParams = new URLSearchParams(window.location.search);
  const donghuaUrl = urlParams.get('url'); // Untuk Donghua
  const animeId = urlParams.get('id');     // Untuk Anime
  let source = urlParams.get('source');

  // Auto detect source if missing
  if (!source) {
    if (animeId) source = 'anime';
    else if (donghuaUrl) source = 'donghua';
  }

  // Setup UI Awal
  const badge = document.getElementById('badgeSrc');
  badge.innerText = source === 'anime' ? "ANIME" : "DONGHUA";
  badge.style.background = source === 'anime' ? "var(--warning)" : "var(--primary)";
  if(source === 'anime') badge.style.color = "#000";

  document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    loadStreamData();
  });

  // =========================
  // MAIN LOAD LOGIC
  // =========================
  async function loadStreamData() {
    try {
        let data = {};

        if (source === 'anime' && animeId) {
            // --- LOAD ANIME ---
            const cleanID = animeId.replace(/\/$/, '').split('/').pop();
            const json = await smartFetch(`${API_ANIME}/episode/${cleanID}`);
            const d = json.data;
            if (!d) throw new Error("Data episode tidak ditemukan");

            data = {
                title: d.title,
                date: d.releasedOn,
                stream: d.defaultStreamingUrl,
                servers: d.server?.qualities || [],
                downloads: d.downloadUrl?.formats || [],
                prev: d.hasPrevEpisode ? `stream.html?id=${cleanId(d.prevEpisode.episodeId)}&source=anime` : null,
                next: d.hasNextEpisode ? `stream.html?id=${cleanId(d.nextEpisode.episodeId)}&source=anime` : null
            };

            renderAnimeServers(data.servers);
            renderAnimeDownloads(data.downloads);

        } else if (donghuaUrl) {
            // --- LOAD DONGHUA ---
            // Donghua API Anichin usually supports CORS direct
            const res = await smartFetch(`${API_DONGHUA}/detail?url=${encodeURIComponent(donghuaUrl)}`);
            
            data = {
                title: res.episode,
                date: "Updated",
                stream: res.streaming?.main_url?.url,
                servers: res.streaming?.servers || [],
                downloads: res.download_url,
                prev: res.navigation?.previous_episode?.anichinUrl 
                    ? `stream.html?url=${encodeURIComponent(res.navigation.previous_episode.anichinUrl)}&source=donghua` : null,
                next: res.navigation?.next_episode?.anichinUrl 
                    ? `stream.html?url=${encodeURIComponent(res.navigation.next_episode.anichinUrl)}&source=donghua` : null
            };

            renderDonghuaServers(data.servers);
            renderDonghuaDownloads(data.downloads);
        }

        // Render Common UI
        document.getElementById('epTitle').innerText = data.title;
        document.getElementById('dateInfo').innerText = data.date || "Just Now";
        
        if (data.stream) {
            document.getElementById('iframePlayer').src = data.stream;
        } else {
            showToast("Stream utama tidak tersedia", "error");
        }

        // Navigation Buttons
        const prevBtn = document.getElementById('btnPrev');
        const nextBtn = document.getElementById('btnNext');

        if(data.prev) {
            prevBtn.style.opacity = "1"; prevBtn.style.pointerEvents = "auto";
            prevBtn.onclick = () => window.location.href = data.prev;
        }
        if(data.next) {
            nextBtn.style.opacity = "1"; nextBtn.style.pointerEvents = "auto";
            nextBtn.onclick = () => window.location.href = data.next;
        }

        saveHistory(data.title);

    } catch (e) {
        console.error(e);
        document.getElementById('epTitle').innerText = "Gagal Memuat: " + e.message;
        showToast("Terjadi kesalahan jaringan", "error");
    }
  }

  // =========================
  // RENDERERS (ANIME)
  // =========================
  function renderAnimeServers(qualities) {
    const box = document.getElementById('serverListContainer');
    if (!qualities || qualities.length === 0) {
        box.innerHTML = "<p style='font-size:0.8rem'>Server Default Only.</p>";
        return;
    }

    let html = `<div class="server-group">
        <div class="server-label">DEFAULT PLAYER</div>
        <div class="server-grid">
            <button class="btn-server active" onclick="location.reload()">DEFAULT</button>
        </div>
    </div>`;

    qualities.forEach(q => {
        if(q.serverList && q.serverList.length > 0) {
            html += `<div class="server-group">
                <div class="server-label">${q.title}</div>
                <div class="server-grid">`;
            q.serverList.forEach(s => {
                html += `<button class="btn-server" onclick="playAnimeServer('${s.serverId}', this)">${s.title}</button>`;
            });
            html += `</div></div>`;
        }
    });
    box.innerHTML = html;
  }

  async function playAnimeServer(id, btn) {
    const oldText = btn.innerText;
    btn.innerText = "...";
    try {
        const json = await smartFetch(`${API_ANIME}/server/${id}`);
        // Fallback property check
        const url = json.data?.url || json.data?.streamingUrl || json.url;
        
        if(url) {
            document.getElementById('iframePlayer').src = url;
            resetActiveServer();
            btn.classList.add('active');
            btn.innerText = oldText;
            showToast("Server diganti: " + oldText);
        } else { throw new Error("Url kosong"); }
    } catch(e) {
        showToast("Gagal memuat server", "error");
        btn.innerText = oldText;
    }
  }

  function renderAnimeDownloads(formats) {
    const box = document.getElementById('dlContainer');
    if(!formats || formats.length === 0) {
        box.innerHTML = "<p style='font-size:0.8rem; color:#888'>Tidak ada link download.</p>";
        return;
    }
    
    let html = "";
    formats.forEach(f => {
        html += `<div class="dl-row"><div class="dl-res">${f.title}</div><div class="dl-links">`;
        if(f.qualities) {
            f.qualities.forEach(q => {
                (q.urls || []).forEach(u => {
                    html += `<a href="${u.url}" target="_blank" class="btn-dl">${q.title} (${u.title})</a>`;
                });
            });
        }
        html += `</div></div>`;
    });
    box.innerHTML = html;
  }

  // =========================
  // RENDERERS (DONGHUA)
  // =========================
  function renderDonghuaServers(servers) {
    const box = document.getElementById('serverListContainer');
    if(!servers || servers.length === 0) return;

    let html = `<div class="server-group">
        <div class="server-label">AVAILABLE SERVERS</div>
        <div class="server-grid">`;
    servers.forEach(s => {
        html += `<button class="btn-server" onclick="changePlayer('${s.url}', this)">${s.name}</button>`;
    });
    html += `</div></div>`;
    box.innerHTML = html;
  }

  function renderDonghuaDownloads(list) {
    const box = document.getElementById('dlContainer');
    if(!list) return;
    
    let html = "";
    for (const [k, v] of Object.entries(list)) {
        html += `<div class="dl-row">
            <div class="dl-res">${k.replace('download_url_','').toUpperCase()}</div>
            <div class="dl-links">`;
        for (const [p, u] of Object.entries(v)) {
            html += `<a href="${u}" target="_blank" class="btn-dl">${p}</a>`;
        }
        html += `</div></div>`;
    }
    box.innerHTML = html;
  }

  // =========================
  // UTILS
  // =========================
  function changePlayer(url, btn) {
    document.getElementById('iframePlayer').src = url;
    resetActiveServer();
    btn.classList.add('active');
    showToast("Server diganti");
  }

  function resetActiveServer() {
    document.querySelectorAll('.btn-server').forEach(b => b.classList.remove('active'));
  }

  function toggleDl() {
    const el = document.getElementById('dlContainer');
    const icon = document.getElementById('dlIcon');
    if (el.style.display === 'none') {
        el.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        el.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
  }

  function goToSeries() {
    let slug = "";
    if (source === 'anime') {
        slug = cleanId(animeId).replace(/-episode-\d+.*$/i, '');
    } else {
        slug = cleanId(donghuaUrl).replace(/-episode-\d+.*$/i, '');
    }
    window.location.href = `series.html?slug=${slug}&source=${source}`;
  }

  function cleanId(str) { return str ? str.replace(/\/$/, '').split('/').pop() : ""; }

  function showToast(msg, type="success") {
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerText = msg;
    if(type === 'error') t.style.borderColor = '#ef4444';
    else t.style.borderColor = '#22c55e';
    
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }

  function saveHistory(title) {
    let hist = JSON.parse(localStorage.getItem('my_history')) || [];
    const key = source === 'anime' ? cleanId(animeId) : donghuaUrl;
    
    // Hapus duplikat lama
    hist = hist.filter(h => h.url !== key);
    
    // Tambah baru di atas
    hist.unshift({
        title: title,
        url: key,
        source: source,
        date: new Date().toLocaleDateString()
    });
    
    // Simpan max 20 item
    localStorage.setItem('my_history', JSON.stringify(hist.slice(0, 20)));
  }

</script>
</body>
</html>
