<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nonton - RayStream</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .server-group { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
    .server-group:last-child { border-bottom: none; }

    .quality-tag {
      font-size: 0.75rem; color: var(--primary); font-weight: 800;
      margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
    }

    .server-grid { display: flex; flex-wrap: wrap; gap: 8px; }

    .btn-server {
      padding: 8px 14px; background: #222;
      border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
      color: #ccc; font-size: 0.75rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s; min-width: 80px; text-align: center;
    }
    .btn-server:hover { background: #333; border-color: rgba(255,255,255,0.3); }
    .btn-server.active {
      background: var(--primary); color: white; border-color: var(--primary);
      box-shadow: 0 0 15px var(--primary-glow);
    }

    .dl-row { margin-bottom: 12px; display: flex; flex-direction: column; gap: 5px; }
    .dl-format { font-size: 0.8rem; font-weight: 700; color: var(--secondary); }
    .dl-items { display: flex; flex-wrap: wrap; gap: 5px; }
  </style>
</head>
<body>

<div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px;"></div>

<header>
  <div onclick="history.back()" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
    <i data-lucide="arrow-left" style="color:var(--text-main); width:22px;"></i>
    <span style="font-weight:600;">Kembali</span>
  </div>
  <div class="logo">STREAM</div>
  <div style="width:24px;"></div>
</header>

<div class="container" style="padding-top: 0; max-width: 900px;">

  <div class="video-box">
    <div class="video-wrapper">
      <iframe id="iframePlayer" src="" allowfullscreen allow="autoplay; encrypted-media; picture-in-picture"></iframe>
    </div>
  </div>

  <div class="panel">
    <h1 id="epTitle" class="ep-title">Memuat Video...</h1>
    <div class="ep-meta">
      <span id="badgeSrc" class="badge" style="background:var(--primary);">SOURCE</span>
      <span class="badge">HD</span>
      <span id="dateInfo">Updated</span>
    </div>
  </div>

  <div style="display:flex; gap:10px; margin-bottom: 20px;">
    <button id="btnPrev" class="btn" style="flex:1; display:none;">&laquo; Prev</button>
    <button class="btn" style="flex:1; background:#333;" onclick="goToSeries()">Info Series</button>
    <button id="btnNext" class="btn btn-primary" style="flex:1; display:none;">Next &raquo;</button>
  </div>

  <div class="panel">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px;">
      <i data-lucide="server" style="width:18px; color:var(--primary);"></i>
      <span style="font-weight:600;">Ganti Server / Resolusi</span>
    </div>
    <div id="serverListContainer">
      <p style="font-size:0.8rem; color:#666;">Memuat daftar server...</p>
    </div>
  </div>

  <div class="panel">
    <div onclick="toggleDl()" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
      <div style="display:flex; align-items:center; gap:8px;">
        <i data-lucide="download-cloud" style="width:18px; color:var(--secondary);"></i>
        <span style="font-weight:600;">Link Download</span>
      </div>
      <i data-lucide="chevron-down" id="dlIcon"></i>
    </div>
    <div id="dlContainer" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px;"></div>
  </div>

</div>

<script>
  // =========================
  // API CONFIG
  // =========================
  const API_DONGHUA = "https://anichin-seven.vercel.app/api";
  const API_ANIME   = "https://www.sankavollerei.com/anime/samehadaku"; // ✅ balik ke SankaVollerei

  // =========================
  // URL PARAMS
  // =========================
  const urlParams = new URLSearchParams(window.location.search);
  const donghuaUrl = urlParams.get('url');
  const animeId = urlParams.get('id');
  let source = urlParams.get('source');

  if (!source) {
    if (animeId) source = 'anime';
    else if (donghuaUrl) source = 'donghua';
  }

  function cleanId(str) {
    if(!str) return "";
    return str.replace(/\/$/, '').split('/').pop();
  }

  async function loadStream() {
    try {
      // Badge UI
      const badge = document.getElementById('badgeSrc');
      badge.innerText = source === 'anime' ? "ANIME" : "DONGHUA";
      badge.style.background = source === 'anime' ? "#f59e0b" : "#3b82f6";

      let data = {};

      // =========================================
      // SCENARIO 1: ANIME (SAMEHADAKU via SankaVollerei)
      // =========================================
      if (source === 'anime' && animeId) {
        const cleanAnimeId = cleanId(animeId);

        const res = await fetch(`${API_ANIME}/episode/${cleanAnimeId}`);
        if (!res.ok) throw new Error("Gagal mengambil data Anime");

        const json = await res.json();
        const d = json?.data;
        if (!d) throw new Error("Episode tidak ditemukan");

        // Meta
        if (d.releasedOn) document.getElementById('dateInfo').innerText = d.releasedOn;

        data = {
          title: d.title,
          stream: d.defaultStreamingUrl,
          animeServers: d.server?.qualities || [],
          downloads: d.downloadUrl?.formats || [],
          prev: d.hasPrevEpisode && d.prevEpisode?.episodeId
            ? `stream.html?id=${cleanId(d.prevEpisode.episodeId)}&source=anime`
            : null,
          next: d.hasNextEpisode && d.nextEpisode?.episodeId
            ? `stream.html?id=${cleanId(d.nextEpisode.episodeId)}&source=anime`
            : null
        };

        renderAnimeServers(data.animeServers);
        renderAnimeDownloads(data.downloads);
      }

      // =========================================
      // SCENARIO 2: DONGHUA (ANICHIN)
      // =========================================
      else if (donghuaUrl) {
        const res = await fetch(`${API_DONGHUA}/detail?url=${encodeURIComponent(donghuaUrl)}`);
        const json = await res.json();

        if (!json?.streaming?.main_url?.url) throw new Error("Stream Donghua Error");

        data = {
          title: json.episode,
          stream: json.streaming.main_url.url,
          donghuaServers: json.streaming.servers || [],
          downloads: json.download_url,
          prev: json.navigation?.previous_episode?.anichinUrl
            ? `stream.html?url=${encodeURIComponent(json.navigation.previous_episode.anichinUrl)}&source=donghua`
            : null,
          next: json.navigation?.next_episode?.anichinUrl
            ? `stream.html?url=${encodeURIComponent(json.navigation.next_episode.anichinUrl)}&source=donghua`
            : null
        };

        renderDonghuaServers(data.donghuaServers);
        renderDonghuaDownloads(data.downloads);
      } else {
        throw new Error("URL/ID tidak ada. Parameter kamu kosong.");
      }

      // Render umum
      document.getElementById('epTitle').innerText = data.title || "Tanpa Judul";

      if (data.stream) {
        document.getElementById('iframePlayer').src = data.stream;
      } else {
        showToast("Stream utama kosong.", "error");
      }

      // Navigasi
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');

      if (data.prev) {
        btnPrev.style.display = 'block';
        btnPrev.onclick = () => window.location.href = data.prev;
      }
      if (data.next) {
        btnNext.style.display = 'block';
        btnNext.onclick = () => window.location.href = data.next;
      }

      // History
      const historyKey = source === 'anime' ? cleanId(animeId) : donghuaUrl;
      saveHistory(data.title, historyKey, source);

      lucide.createIcons();
    } catch (e) {
      console.error(e);
      document.getElementById('epTitle').innerText = "Gagal: " + e.message;
      document.getElementById('serverListContainer').innerHTML = `<p style="color:#ef4444;">${e.message}</p>`;
    }
  }

  // =========================
  // SERVER ANIME
  // =========================
  function renderAnimeServers(qualities) {
    const container = document.getElementById('serverListContainer');
    if (!qualities || qualities.length === 0) {
      container.innerHTML = "<p>Server default only.</p>";
      return;
    }

    let html = "";
    html += `<div class="server-group">
      <div class="quality-tag">DEFAULT</div>
      <div class="server-grid">
        <button class="btn-server active" onclick="resetPlayer()">DEFAULT PLAYER</button>
      </div>
    </div>`;

    qualities.forEach(q => {
      if (q.serverList && q.serverList.length > 0) {
        html += `<div class="server-group">`;
        html += `<div class="quality-tag">${q.title}</div>`;
        html += `<div class="server-grid">`;

        q.serverList.forEach(srv => {
          const serverId = srv.serverId;
          html += `<button class="btn-server" onclick="fetchAndPlayAnimeServer('${serverId}', this)">
            ${srv.title}
          </button>`;
        });

        html += `</div></div>`;
      }
    });

    container.innerHTML = html;
  }

  async function fetchAndPlayAnimeServer(serverId, btn) {
    const originalText = btn.innerText;
    btn.innerText = "Loading...";

    document.querySelectorAll('.btn-server').forEach(b => b.classList.remove('active'));

    try {
      // ✅ endpoint server dari SankaVollerei
      const res = await fetch(`${API_ANIME}/server/${serverId}`);
      if(!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();

      // fallback handle beberapa bentuk response
      const url =
        json?.data?.url ||
        json?.data?.streamingUrl ||
        json?.url ||
        json?.streamingUrl;

      if (url) {
        document.getElementById('iframePlayer').src = url;
        btn.classList.add('active');
        showToast("Server berhasil diganti!", "success");
      } else {
        showToast("Gagal mengambil link server.", "error");
      }
    } catch (e) {
      console.error(e);
      showToast("Server Error.", "error");
    } finally {
      btn.innerText = originalText;
    }
  }

  // =========================
  // SERVER DONGHUA
  // =========================
  function renderDonghuaServers(servers) {
    const container = document.getElementById('serverListContainer');
    if (!servers || servers.length === 0) return;

    let html = `<div class="server-group"><div class="quality-tag">AVAILABLE SERVERS</div><div class="server-grid">`;
    servers.forEach((s) => {
      html += `<button class="btn-server" onclick="changePlayer('${s.url}', this)">${s.name}</button>`;
    });
    html += `</div></div>`;
    container.innerHTML = html;
  }

  // =========================
  // DOWNLOADS
  // =========================
  function renderAnimeDownloads(formats) {
    if(!formats || formats.length === 0) return;
    let html = "";

    formats.forEach(fmt => {
      html += `<div class="dl-row">`;
      html += `<div class="dl-format">${fmt.title}</div>`;

      if(fmt.qualities) {
        fmt.qualities.forEach(q => {
          html += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">`;
          html += `<span style="font-size:0.7rem; color:#888; width:50px;">${q.title}</span>`;
          html += `<div class="dl-items">`;

          (q.urls || []).forEach(u => {
            html += `<a href="${u.url}" target="_blank" class="btn"
              style="padding:4px 8px; font-size:0.65rem; height:auto; background:#222; border:1px solid #333;">
              ${u.title}
            </a>`;
          });

          html += `</div></div>`;
        });
      }

      html += `</div>`;
    });

    document.getElementById('dlContainer').innerHTML = html;
  }

  function renderDonghuaDownloads(list) {
    if(!list) return;
    let html = "";

    for (const [k, v] of Object.entries(list)) {
      html += `<div class="dl-row">
        <div class="dl-format">${k.replace('download_url_','').toUpperCase()}</div>
        <div class="dl-items">`;

      for (const [p, u] of Object.entries(v)) {
        html += `<a href="${u}" target="_blank" class="btn" style="padding:4px 8px; font-size:0.7rem;">${p}</a>`;
      }

      html += `</div></div>`;
    }

    document.getElementById('dlContainer').innerHTML = html;
  }

  // =========================
  // UTILS
  // =========================
  function changePlayer(url, btn) {
    document.getElementById('iframePlayer').src = url;
    document.querySelectorAll('.btn-server').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    showToast("Server diganti", "success");
  }

  function resetPlayer() {
    location.reload();
  }

  function toggleDl() {
    const el = document.getElementById('dlContainer');
    const icon = document.getElementById('dlIcon');
    const isHidden = el.style.display === 'none';
    el.style.display = isHidden ? 'block' : 'none';
    icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
  }

  function goToSeries() {
    let slug = source === 'anime'
      ? cleanId(animeId).replace(/-episode-\d+.*$/i, '')
      : cleanId(donghuaUrl).replace(/-episode-\d+.*$/i, '');

    window.location.href = `series.html?slug=${slug}&source=${source}`;
  }

  function showToast(msg, type) {
    const t = document.createElement('div');
    t.style.cssText = `background:#222; color:#fff; padding:12px 20px; border-radius:50px; border-left:4px solid ${type==='error'?'#ef4444':'#22c55e'}; font-size:0.9rem; box-shadow:0 10px 30px rgba(0,0,0,0.5);`;
    t.innerText = msg;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }

  function saveHistory(title, key, src) {
    let hist = JSON.parse(localStorage.getItem('my_history')) || [];
    hist = hist.filter(h => h.url !== key);

    let poster = "https://via.placeholder.com/150";
    hist.unshift({ title, url: key, source: src, poster, date: new Date().toLocaleDateString() });

    localStorage.setItem('my_history', JSON.stringify(hist));
  }

  loadStream();
  lucide.createIcons();
</script>
</body>
</html>
