<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Donghua</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<div id="toast-container"></div>

<header>
    <i data-lucide="arrow-left" onclick="history.back()" style="cursor:pointer; color:var(--primary);"></i>
    <div class="logo" style="font-size:1.1rem;">STREAM</div>
    <div></div> </header>

<div class="container" style="padding-top: 0;">
    <div class="video-container-responsive">
        <iframe id="iframePlayer" src="" allowfullscreen></iframe>
    </div>

    <div style="margin-top: 20px;">
        <h1 id="epTitle" style="font-size: 1.1rem; margin-bottom: 15px; line-height: 1.4; font-weight: 700;">Loading...</h1>
        
        <div style="display:flex; gap:10px; margin-bottom: 25px;">
            <button id="btnPrev" class="btn" style="flex:1; display:none;">&laquo; Prev</button>
            <button class="btn" style="flex:1; background: #222;" onclick="window.location.href='series.html?slug=' + getSlugFromUrl()">Series Info</button>
            <button id="btnNext" class="btn" style="flex:1; display:none;">Next &raquo;</button>
        </div>

        <div style="background: var(--bg-card); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px;">
            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">SERVER STREAMING:</p>
            <div id="serverList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>

        <div style="background: var(--bg-card); padding: 15px; border-radius: var(--radius-md);">
            <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleDl()">
                <span style="font-weight:600; display:flex; align-items:center; gap:8px;"><i data-lucide="download"></i> Download Episode</span>
                <i data-lucide="chevron-down" id="dlIcon" style="transition:0.3s;"></i>
            </div>
            <div id="dlContainer" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = "https://anichin-seven.vercel.app/api";
    const urlParams = new URLSearchParams(window.location.search);
    const animeUrl = urlParams.get('url');

    // --- FUNGSI TOAST ALERT MODERN ---
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        // Ikon berdasarkan tipe
        const icon = type === 'error' ? 'alert-circle' : (type === 'success' ? 'check-circle' : 'info');
        toast.innerHTML = `<i data-lucide="${icon}" style="width:18px;"></i> <span>${message}</span>`;
        
        container.appendChild(toast);
        lucide.createIcons(); // Render ikon di dalam toast

        // Hapus otomatis setelah 3 detik
        setTimeout(() => {
            toast.style.animation = 'toastOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Helper untuk tombol "Series Info"
    function getSlugFromUrl() {
        if (!animeUrl) return '';
        let clean = animeUrl.replace(/\/$/, '');
        let segment = clean.substring(clean.lastIndexOf('/') + 1);
        return segment.replace(/-episode-\d+.*$/i, '');
    }

    async function loadStream() {
        if (!animeUrl) {
            showToast("URL Episode tidak valid", 'error');
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/detail?url=${animeUrl}`);
            const json = await res.json();

            if (!json.status || json.status !== "success") throw new Error("Gagal memuat data API");

            document.getElementById('epTitle').innerText = json.episode;
            changePlayer(json.streaming.main_url.url, null); // Load default

            // Render Servers
            document.getElementById('serverList').innerHTML = json.streaming.servers.map((srv, i) => 
                `<button class="btn ${i===0 ? 'btn-primary' : ''} server-btn" style="font-size:0.75rem; padding:8px 12px;" onclick="changePlayer('${srv.url}', this)">${srv.name}</button>`
            ).join('');

            // Render Nav Prev/Next
            if (json.navigation.previous_episode) {
                const btn = document.getElementById('btnPrev');
                btn.style.display = 'block';
                btn.onclick = () => window.location.href = `stream.html?url=${json.navigation.previous_episode.anichinUrl}`;
            }
            if (json.navigation.next_episode) {
                const btn = document.getElementById('btnNext');
                btn.style.display = 'block';
                btn.onclick = () => window.location.href = `stream.html?url=${json.navigation.next_episode.anichinUrl}`;
            }

            // Render Downloads
            let dlHtml = "";
            for (const [res, links] of Object.entries(json.download_url)) {
                const label = res.replace('download_url_', '').toUpperCase();
                dlHtml += `<div style="margin-bottom:12px;">
                    <span style="color:var(--primary); font-size:0.75rem; font-weight:700;">${label}</span>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:5px;">`;
                for (const [provider, url] of Object.entries(links)) {
                    dlHtml += `<a href="${url}" target="_blank" class="btn btn-outline" style="font-size:0.7rem; padding:4px 10px;">${provider}</a>`;
                }
                dlHtml += `</div></div>`;
            }
            document.getElementById('dlContainer').innerHTML = dlHtml;

            saveToHistory(json.episode, animeUrl);
            lucide.createIcons();

        } catch (e) {
            console.error(e);
            document.getElementById('epTitle').innerText = "Error memuat stream.";
            showToast("Gagal memuat data stream. Coba refresh.", 'error');
        }
    }

    function changePlayer(url, btn) {
        document.getElementById('iframePlayer').src = url;
        // Update visual tombol aktif
        if(btn) {
            document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('btn-primary'));
            btn.classList.add('btn-primary');
        }
        showToast("Server diganti", 'success');
    }

    function toggleDl() {
        const el = document.getElementById('dlContainer');
        const icon = document.getElementById('dlIcon');
        const isHidden = el.style.display === 'none';
        el.style.display = isHidden ? 'block' : 'none';
        icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function saveToHistory(title, url) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        hist = hist.filter(h => h.url !== url);
        hist.unshift({ title: title, url: url, date: new Date().toLocaleDateString() });
        localStorage.setItem('my_history', JSON.stringify(hist));
    }

    loadStream();
</script>
</body>
</html>
