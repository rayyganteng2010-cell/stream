<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nonton - RayStream</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* CSS Khusus Server Grid yang Rapi */
    .server-group { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
    .server-group:last-child { border-bottom: none; }

    .quality-tag {
      font-size: 0.75rem; color: var(--primary); font-weight: 800;
      margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
    }

    .server-grid { display: flex; flex-wrap: wrap; gap: 8px; }

    .btn-server{
      padding: 8px 14px; background: #222;
      border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
      color: #ccc; font-size: 0.75rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s; min-width: 80px; text-align: center;
    }
    .btn-server:hover{ background:#333; border-color: rgba(255,255,255,0.3); }
    .btn-server.active{
      background: var(--primary); color: white; border-color: var(--primary);
      box-shadow: 0 0 15px var(--primary-glow);
    }

    /* Download Style */
    .dl-row { margin-bottom: 12px; display: flex; flex-direction: column; gap: 5px; }
    .dl-format { font-size: 0.8rem; font-weight: 700; color: var(--secondary); }
    .dl-items { display: flex; flex-wrap: wrap; gap: 6px; }

    /* iframe wrapper */
    .video-wrapper{ position:relative; padding-top:56.25%; background:#000; border-radius: 16px; overflow:hidden; }
    .video-wrapper iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }
  </style>
</head>

<body>
  <div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px;"></div>

  <header>
    <div onclick="history.back()" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
      <i data-lucide="arrow-left" style="color:var(--text-main); width:22px;"></i>
      <span style="font-weight:600;">Kembali</span>
    </div>
    <div class="logo">STREAM</div>
    <div style="width:24px;"></div>
  </header>

  <div class="container" style="padding-top: 0; max-width: 900px;">
    <div class="video-box">
      <div class="video-wrapper">
        <iframe id="iframePlayer" src="" allowfullscreen allow="autoplay; encrypted-media; picture-in-picture"></iframe>
      </div>
    </div>

    <div class="panel">
      <h1 id="epTitle" class="ep-title">Memuat Video...</h1>
      <div class="ep-meta">
        <span id="badgeSrc" class="badge" style="background:var(--primary);">SOURCE</span>
        <span class="badge">HD</span>
        <span id="dateInfo">Updated Today</span>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-bottom: 20px;">
      <button id="btnPrev" class="btn" style="flex:1; display:none;">&laquo; Prev</button>
      <button class="btn" style="flex:1; background:#333;" onclick="goToSeries()">Info Series</button>
      <button id="btnNext" class="btn btn-primary" style="flex:1; display:none;">Next &raquo;</button>
    </div>

    <div class="panel">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px;">
        <i data-lucide="server" style="width:18px; color:var(--primary);"></i>
        <span style="font-weight:600;">Ganti Server / Resolusi</span>
      </div>
      <div id="serverListContainer">
        <p style="font-size:0.8rem; color:#666;">Memuat daftar server...</p>
      </div>
    </div>

    <div class="panel">
      <div onclick="toggleDl()" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
        <div style="display:flex; align-items:center; gap:8px;">
          <i data-lucide="download-cloud" style="width:18px; color:var(--secondary);"></i>
          <span style="font-weight:600;">Link Download</span>
        </div>
        <i data-lucide="chevron-down" id="dlIcon"></i>
      </div>
      <div id="dlContainer" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px;"></div>
    </div>
  </div>

<script>
  // =========================
  // API CONFIG
  // =========================
  const API_DONGHUA = "https://anichin-seven.vercel.app/api";
  // Proxy Samehadaku (punyamu)
  const API_ANIME   = "https://donghua-qnha.vercel.app/anime/samehadaku";

  // =========================
  // URL PARAMS
  // =========================
  const urlParams = new URLSearchParams(window.location.search);
  const donghuaUrl = urlParams.get("url"); // full URL anichin episode
  const animeId    = urlParams.get("id");  // samehadaku episodeId
  let source       = urlParams.get("source"); // 'anime' | 'donghua'

  // Smart fallback
  if (!source) {
    if (animeId) source = "anime";
    else if (donghuaUrl) source = "donghua";
  }

  let CURRENT = {
    source: source,
    title: "",
    defaultStream: "",
    currentStream: "",
    animeEpisodeId: "",
    donghuaEpisodeUrl: "",
    prevUrl: null,
    nextUrl: null
  };

  function cleanId(str) {
    if (!str) return "";
    return str.replace(/\/$/, "").split("/").pop();
  }

  function setActive(btn) {
    document.querySelectorAll(".btn-server").forEach(b => b.classList.remove("active"));
    if (btn) btn.classList.add("active");
  }

  function setPlayer(url) {
    const iframe = document.getElementById("iframePlayer");
    if (!url) return;
    // reset dulu biar reload bersih di beberapa browser
    iframe.src = "about:blank";
    setTimeout(() => iframe.src = url, 50);
    CURRENT.currentStream = url;
  }

  // =========================
  // MAIN
  // =========================
  async function loadStream() {
    try {
      // Badge UI
      const badge = document.getElementById("badgeSrc");
      badge.innerText = (source === "anime") ? "ANIME" : "DONGHUA";
      badge.style.background = (source === "anime") ? "#f59e0b" : "#3b82f6";

      // Clear UI dulu
      document.getElementById("serverListContainer").innerHTML = `<p style="font-size:0.8rem; color:#666;">Memuat daftar server...</p>`;
      document.getElementById("dlContainer").innerHTML = "";

      // =====================
      // SCENARIO: ANIME
      // =====================
      if (source === "anime" && animeId) {
        const epId = cleanId(animeId);
        CURRENT.animeEpisodeId = epId;

        const res = await fetch(`${API_ANIME}/episode/${epId}`);
        if (!res.ok) throw new Error("Gagal mengambil data Anime");
        const json = await res.json();

        const d = json.data;
        if (!d) throw new Error("Episode anime tidak ditemukan");

        const title = d.title || "Nonton Anime";
        const defaultStream = d.defaultStreamingUrl || "";

        CURRENT.title = title;
        CURRENT.defaultStream = defaultStream;
        CURRENT.currentStream = defaultStream;

        // Navigasi
        CURRENT.prevUrl = d.hasPrevEpisode && d.prevEpisode?.episodeId
          ? `stream.html?source=anime&id=${encodeURIComponent(cleanId(d.prevEpisode.episodeId))}`
          : null;

        CURRENT.nextUrl = d.hasNextEpisode && d.nextEpisode?.episodeId
          ? `stream.html?source=anime&id=${encodeURIComponent(cleanId(d.nextEpisode.episodeId))}`
          : null;

        // Render server anime
        renderAnimeServers(d.server?.qualities || []);

        // Download anime
        // beberapa API pakai downloadUrl.formats atau downloadUrl.formats[].qualities[].urls
        renderAnimeDownloads(d.downloadUrl?.formats || []);

        // Set player
        if (defaultStream) {
          setPlayer(defaultStream);
        } else {
          showToast("Stream default anime kosong.", "error");
        }

      // =====================
      // SCENARIO: DONGHUA
      // =====================
      } else if (source === "donghua" && donghuaUrl) {
        CURRENT.donghuaEpisodeUrl = donghuaUrl;

        const res = await fetch(`${API_DONGHUA}/detail?url=${encodeURIComponent(donghuaUrl)}`);
        if (!res.ok) throw new Error("Gagal mengambil data Donghua");
        const json = await res.json();

        if (!json.streaming || !json.streaming.main_url?.url) {
          throw new Error("Stream donghua tidak tersedia");
        }

        const title = json.episode || "Nonton Donghua";
        const defaultStream = json.streaming.main_url.url;

        CURRENT.title = title;
        CURRENT.defaultStream = defaultStream;
        CURRENT.currentStream = defaultStream;

        // Navigasi
        CURRENT.prevUrl = json.navigation?.previous_episode?.anichinUrl
          ? `stream.html?source=donghua&url=${encodeURIComponent(json.navigation.previous_episode.anichinUrl)}`
          : null;

        CURRENT.nextUrl = json.navigation?.next_episode?.anichinUrl
          ? `stream.html?source=donghua&url=${encodeURIComponent(json.navigation.next_episode.anichinUrl)}`
          : null;

        // Render server donghua
        renderDonghuaServers(json.streaming.servers || []);

        // Download donghua
        renderDonghuaDownloads(json.download_url || null);

        // Set player
        setPlayer(defaultStream);

      } else {
        throw new Error("Parameter salah. Pakai ?source=anime&id=... atau ?source=donghua&url=...");
      }

      // Render umum
      document.getElementById("epTitle").innerText = CURRENT.title;

      // Tombol prev/next
      setupPrevNext();

      // Save history (simple)
      const histKey = (source === "anime") ? CURRENT.animeEpisodeId : CURRENT.donghuaEpisodeUrl;
      saveHistory(CURRENT.title, histKey, source);

      lucide.createIcons();
    } catch (e) {
      console.error(e);
      document.getElementById("epTitle").innerText = "Gagal: " + e.message;
      document.getElementById("serverListContainer").innerHTML = `<p style="color:#ef4444;">${e.message}</p>`;
      showToast(e.message, "error");
    }
  }

  function setupPrevNext() {
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");

    if (CURRENT.prevUrl) {
      btnPrev.style.display = "block";
      btnPrev.onclick = () => window.location.href = CURRENT.prevUrl;
    } else {
      btnPrev.style.display = "none";
    }

    if (CURRENT.nextUrl) {
      btnNext.style.display = "block";
      btnNext.onclick = () => window.location.href = CURRENT.nextUrl;
    } else {
      btnNext.style.display = "none";
    }
  }

  // =========================
  // SERVER: ANIME (SAMEHADAKU)
  // qualities: [{ title: "360p", serverList:[{title, serverId}, ...] }, ...]
  // =========================
  function renderAnimeServers(qualities) {
    const container = document.getElementById("serverListContainer");

    let html = "";
    html += `
      <div class="server-group">
        <div class="quality-tag">DEFAULT</div>
        <div class="server-grid">
          <button class="btn-server active" onclick="resetToDefault(this)">DEFAULT PLAYER</button>
        </div>
      </div>
    `;

    if (!qualities || qualities.length === 0) {
      container.innerHTML = html + `<p style="font-size:0.8rem;color:#777;margin-top:8px;">Server tambahan tidak tersedia.</p>`;
      return;
    }

    qualities.forEach(q => {
      if (!q.serverList || q.serverList.length === 0) return;

      html += `<div class="server-group">`;
      html += `<div class="quality-tag">${escapeHtml(q.title || "QUALITY")}</div>`;
      html += `<div class="server-grid">`;

      q.serverList.forEach(srv => {
        const sid = srv.serverId;
        const stitle = srv.title || "Server";
        html += `
          <button class="btn-server" onclick="fetchAndPlayAnimeServer('${encodeURIComponent(sid)}', this)">
            ${escapeHtml(stitle)}
          </button>
        `;
      });

      html += `</div></div>`;
    });

    container.innerHTML = html;
  }

  async function fetchAndPlayAnimeServer(serverIdEnc, btn) {
    const serverId = decodeURIComponent(serverIdEnc);
    const originalText = btn.innerText;
    btn.innerText = "Loading...";
    setActive(null);

    try {
      const res = await fetch(`${API_ANIME}/server/${serverId}`);
      if (!res.ok) throw new Error("Gagal fetch server anime");

      const json = await res.json();
      // beberapa API balikin data.streamingUrl, beberapa data.url
      const url = json?.data?.streamingUrl || json?.data?.url || json?.data?.streaming_url;

      if (!url) throw new Error("Link server tidak ditemukan");

      setPlayer(url);
      setActive(btn);
      showToast("Server anime diganti", "success");
    } catch (e) {
      console.error(e);
      showToast(e.message || "Server Error", "error");
    } finally {
      btn.innerText = originalText;
    }
  }

  function resetToDefault(btn) {
    if (!CURRENT.defaultStream) {
      showToast("Default stream kosong.", "error");
      return;
    }
    setPlayer(CURRENT.defaultStream);
    setActive(btn);
    showToast("Balik ke default", "success");
  }

  // =========================
  // SERVER: DONGHUA
  // servers: [{ name, url }, ...]
  // =========================
  function renderDonghuaServers(servers) {
    const container = document.getElementById("serverListContainer");
    if (!servers || servers.length === 0) {
      container.innerHTML = `<p style="font-size:0.8rem;color:#777;">Server donghua tidak tersedia.</p>`;
      return;
    }

    let html = `
      <div class="server-group">
        <div class="quality-tag">AVAILABLE SERVERS</div>
        <div class="server-grid">
          <button class="btn-server active" onclick="resetToDefault(this)">DEFAULT PLAYER</button>
    `;

    servers.forEach(s => {
      html += `<button class="btn-server" onclick="changePlayer('${encodeURIComponent(s.url)}', this)">${escapeHtml(s.name || "Server")}</button>`;
    });

    html += `</div></div>`;
    container.innerHTML = html;
  }

  function changePlayer(urlEnc, btn) {
    const url = decodeURIComponent(urlEnc);
    setPlayer(url);
    setActive(btn);
    showToast("Server diganti", "success");
  }

  // =========================
  // DOWNLOADS: ANIME
  // formats: [{ title: "MKV", qualities:[{title:"360p", urls:[{title,url},...]},...] }, ...]
  // =========================
  function renderAnimeDownloads(formats) {
    if (!formats || formats.length === 0) return;

    let html = "";
    formats.forEach(fmt => {
      html += `<div class="dl-row">`;
      html += `<div class="dl-format">${escapeHtml(fmt.title || "FORMAT")}</div>`;

      if (fmt.qualities && Array.isArray(fmt.qualities)) {
        fmt.qualities.forEach(q => {
          html += `<div style="display:flex; align-items:flex-start; gap:8px; margin-bottom:6px;">`;
          html += `<span style="font-size:0.7rem; color:#888; width:48px; padding-top:6px;">${escapeHtml(q.title || "")}</span>`;
          html += `<div class="dl-items">`;

          (q.urls || []).forEach(u => {
            html += `<a href="${u.url}" target="_blank" rel="noopener" class="btn" style="padding:6px 10px; font-size:0.7rem; height:auto; background:#222; border:1px solid #333;">${escapeHtml(u.title || "Link")}</a>`;
          });

          html += `</div></div>`;
        });
      }
      html += `</div>`;
    });

    document.getElementById("dlContainer").innerHTML = html;
  }

  // =========================
  // DOWNLOADS: DONGHUA
  // object: { download_url_xxx: { "360p": "http...", ... }, ... }
  // =========================
  function renderDonghuaDownloads(list) {
    if (!list) return;

    let html = "";
    for (const [k, v] of Object.entries(list)) {
      html += `<div class="dl-row">`;
      html += `<div class="dl-format">${escapeHtml(String(k).replace("download_url_", "").toUpperCase())}</div>`;
      html += `<div class="dl-items">`;

      for (const [p, u] of Object.entries(v || {})) {
        html += `<a href="${u}" target="_blank" rel="noopener" class="btn" style="padding:6px 10px; font-size:0.7rem; height:auto;">${escapeHtml(p)}</a>`;
      }

      html += `</div></div>`;
    }

    document.getElementById("dlContainer").innerHTML = html;
  }

  // =========================
  // UI UTILS
  // =========================
  function toggleDl() {
    const el = document.getElementById("dlContainer");
    const icon = document.getElementById("dlIcon");
    const isHidden = el.style.display === "none";
    el.style.display = isHidden ? "block" : "none";
    icon.style.transform = isHidden ? "rotate(180deg)" : "rotate(0deg)";
  }

  function goToSeries() {
    // Ini best-effort doang, karena series.html kamu yang handle.
    // Anime: buang "-episode-xx" di belakang
    // Donghua: sama
    let slug = "";

    if (source === "anime" && CURRENT.animeEpisodeId) {
      slug = CURRENT.animeEpisodeId.replace(/-episode-\d+.*$/i, "");
      window.location.href = `series.html?source=anime&slug=${encodeURIComponent(slug)}`;
      return;
    }

    if (source === "donghua" && CURRENT.donghuaEpisodeUrl) {
      slug = cleanId(CURRENT.donghuaEpisodeUrl).replace(/-episode-\d+.*$/i, "");
      window.location.href = `series.html?source=donghua&slug=${encodeURIComponent(slug)}`;
      return;
    }

    showToast("Series tidak tersedia", "error");
  }

  function showToast(msg, type) {
    const t = document.createElement("div");
    t.style.cssText = `
      background:#222; color:#fff; padding:12px 20px; border-radius:50px;
      border-left:4px solid ${type === "error" ? "#ef4444" : "#22c55e"};
      font-size:0.9rem; box-shadow:0 10px 30px rgba(0,0,0,0.5);
    `;
    t.innerText = msg;
    document.getElementById("toast-container").appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }

  function saveHistory(title, key, src) {
    try {
      let hist = JSON.parse(localStorage.getItem("my_history")) || [];
      hist = hist.filter(h => h.url !== key && h.key !== key);

      // poster dummy, karena di stream endpoint ga selalu ada poster
      const poster = "https://via.placeholder.com/150";

      hist.unshift({
        title,
        url: key,
        source: src,
        poster,
        date: new Date().toLocaleDateString()
      });

      localStorage.setItem("my_history", JSON.stringify(hist));
    } catch (e) {
      // kalau localStorage error, yaudah
      console.warn("History save failed:", e);
    }
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // START
  loadStream();
  lucide.createIcons();
</script>
</body>
</html>
