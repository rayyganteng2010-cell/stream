<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Donghua</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script> </head>
<body>

<div class="video-wrapper">
    <iframe id="iframePlayer" src="" allowfullscreen></iframe>
</div>

<div style="padding: 20px;">
    <h1 id="epTitle" style="font-size: 1.1rem; margin: 0 0 10px 0; line-height: 1.4;">Loading...</h1>
    
    <div style="display:flex; gap:10px; margin-bottom: 20px;">
        <button id="btnPrev" class="btn" style="flex:1; display:none;" onclick="">&laquo; Prev</button>
        <button class="btn" style="flex:1; background:#333;" onclick="window.location.href='index.html'">Home</button>
        <button id="btnNext" class="btn" style="flex:1; display:none;" onclick="">Next &raquo;</button>
    </div>

    <div style="margin-bottom: 20px;">
        <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:8px;">Ganti Server:</p>
        <div id="serverList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    </div>

    <div style="background: var(--bg-card); padding: 15px; border-radius: var(--radius);">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleDl()">
            <span style="font-weight:bold;">Download</span>
            <i data-lucide="chevron-down"></i>
        </div>
        <div id="dlContainer" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:10px;">
            </div>
    </div>
</div>

<script>
    const API_BASE = "https://anichin-seven.vercel.app/api";
    const urlParams = new URLSearchParams(window.location.search);
    const animeUrl = urlParams.get('url');

    async function loadStream() {
        if (!animeUrl) return alert("URL Error");

        try {
            // Fetch Detail API
            const res = await fetch(`${API_BASE}/detail?url=${animeUrl}`);
            const json = await res.json();

            // 1. Set Title & Default Player
            document.getElementById('epTitle').innerText = json.episode;
            // Ambil URL default (biasanya stream utama)
            changePlayer(json.streaming.main_url.url);

            // 2. Render Servers
            const srvContainer = document.getElementById('serverList');
            srvContainer.innerHTML = json.streaming.servers.map(srv => 
                `<button class="btn" style="font-size:0.75rem; padding:5px 10px;" onclick="changePlayer('${srv.url}')">${srv.name}</button>`
            ).join('');

            // 3. Render Navigation (Prev/Next)
            if (json.navigation.previous_episode) {
                const btn = document.getElementById('btnPrev');
                btn.style.display = 'block';
                btn.onclick = () => window.location.href = `stream.html?url=${json.navigation.previous_episode.anichinUrl}`;
            }
            if (json.navigation.next_episode) {
                const btn = document.getElementById('btnNext');
                btn.style.display = 'block';
                btn.onclick = () => window.location.href = `stream.html?url=${json.navigation.next_episode.anichinUrl}`;
            }

            // 4. Render Downloads
            const dlContainer = document.getElementById('dlContainer');
            let dlHtml = "";
            for (const [res, links] of Object.entries(json.download_url)) {
                // Bersihkan nama key (misal: download_url_360p -> 360P)
                const label = res.replace('download_url_', '').toUpperCase();
                dlHtml += `<div style="margin-bottom:8px;">
                    <span style="color:var(--primary); font-size:0.75rem;">${label}</span>
                    <div style="display:flex; gap:10px; margin-top:4px;">`;
                
                for (const [provider, url] of Object.entries(links)) {
                    dlHtml += `<a href="${url}" target="_blank" style="color:#aaa; text-decoration:none; font-size:0.75rem; border:1px solid #444; padding:2px 8px; border-radius:4px;">${provider}</a>`;
                }
                dlHtml += `</div></div>`;
            }
            dlContainer.innerHTML = dlHtml;

            // 5. Save History
            saveToHistory(json.episode, animeUrl);

            lucide.createIcons();
        } catch (e) {
            console.error(e);
            document.getElementById('epTitle').innerText = "Gagal memuat stream.";
        }
    }

    function changePlayer(url) {
        document.getElementById('iframePlayer').src = url;
    }

    function toggleDl() {
        const el = document.getElementById('dlContainer');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function saveToHistory(title, url) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        // Hapus duplikat
        hist = hist.filter(h => h.url !== url);
        // Tambah baru di atas
        hist.unshift({
            title: title,
            url: url,
            date: new Date().toLocaleDateString()
        });
        localStorage.setItem('my_history', JSON.stringify(hist));
    }

    loadStream();
</script>
</body>
</html>
