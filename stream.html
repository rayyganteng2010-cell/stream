<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>RayStream Player</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --bg-dark: #000000;
      --bg-panel: #121212;
      --primary: #6366f1;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --wa-color: #25D366;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Outfit', sans-serif; }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-panel);
      color: var(--text-main);
      overflow-x: hidden;
      padding-bottom: 60px;
    }

    /* --- HEADER (Floating) --- */
    header {
      position: absolute; top: 0; left: 0; right: 0; z-index: 20;
      display: flex; align-items: center; gap: 15px;
      padding: 15px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
      pointer-events: none;
    }
    
    .header-btn {
      pointer-events: auto;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: white;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .header-title {
      font-size: 0.9rem; font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      flex: 1; opacity: 0.9;
    }

    /* --- PLAYER AREA --- */
    .player-container {
      position: sticky; top: 0; z-index: 10;
      width: 100%;
      background: #000;
      /* Aspect Ratio 16:9 */
      padding-top: 56.25%; 
    }

    .player-frame {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      border: none;
    }

    /* Tombol Force Fullscreen */
    .fs-btn-overlay {
        position: absolute; bottom: 10px; right: 10px;
        background: rgba(0,0,0,0.6); color: white;
        padding: 6px; border-radius: 6px;
        cursor: pointer; z-index: 15;
        border: 1px solid rgba(255,255,255,0.2);
        display: flex; align-items: center; justify-content: center;
    }

    /* --- BODY CONTENT --- */
    .content-body {
      padding: 20px;
      background: var(--bg-panel);
      position: relative; z-index: 11;
      border-radius: 20px 20px 0 0;
      margin-top: -10px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
      min-height: 500px;
    }

    .ep-title {
      font-size: 1.1rem; font-weight: 700; line-height: 1.4; margin-bottom: 8px;
    }

    .ep-meta {
      display: flex; align-items: center; gap: 10px;
      font-size: 0.75rem; color: var(--text-muted); margin-bottom: 20px;
    }

    .badge {
      padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 0.7rem;
    }
    .badge-src { background: var(--primary); color: #fff; }

    /* Nav Buttons */
    .nav-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
    }
    .btn-nav {
      background: #1f1f22; color: #fff; border: 1px solid rgba(255,255,255,0.05);
      padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-nav:disabled { opacity: 0.5; pointer-events: none; }

    /* WA Button */
    .btn-wa {
      background: var(--wa-color); color: #fff;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      width: 100%; padding: 14px; border-radius: 16px;
      font-weight: 700; text-decoration: none; margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.2);
    }

    /* Server List Box */
    .server-box {
      background: #1f1f22; border-radius: 16px; padding: 15px; margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .server-label {
        font-size: 0.7rem; color: var(--text-muted); margin-bottom: 10px;
        display: flex; justify-content: space-between;
    }
    .server-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px;
    }
    .btn-srv {
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
        padding: 8px; border-radius: 8px; color: #ccc;
        font-size: 0.75rem; font-weight: 600; cursor: pointer; text-align: center;
        text-transform: uppercase;
    }
    .btn-srv.active {
        background: var(--primary); color: #fff; border-color: var(--primary);
    }

    /* Download List */
    .dl-section { display: none; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
    .dl-item { background: #18181b; padding: 10px; border-radius: 8px; margin-bottom: 5px; }
    .dl-links a { 
        display: inline-block; padding: 4px 8px; background: rgba(255,255,255,0.1); 
        color: #fff; font-size: 0.7rem; border-radius: 4px; text-decoration: none; margin-right: 5px;
    }

    /* Toast Notification */
    #toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: #333; padding: 10px 20px; border-radius: 30px; color: #fff;
      font-size: 0.8rem; z-index: 100; opacity: 0; transition: 0.3s; pointer-events: none;
      white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  </style>
</head>
<body>

<header>
  <div class="header-btn" onclick="history.back()">
    <i data-lucide="arrow-left" width="20"></i>
  </div>
  <div class="header-title" id="headerTitle">Memuat...</div>
</header>

<div class="player-container">
    <iframe id="iframePlayer" class="player-frame" src="" 
        sandbox="allow-scripts allow-same-origin allow-presentation allow-forms"
        allowfullscreen="true" 
        allow="autoplay; fullscreen; encrypted-media; picture-in-picture">
    </iframe>

    <div class="fs-btn-overlay" onclick="toggleFullScreen()">
        <i data-lucide="maximize" width="16"></i>
    </div>
</div>

<div class="content-body">
    
    <div class="ep-title" id="epTitle">Memuat Data...</div>
    <div class="ep-meta">
        <span class="badge badge-src">DONGHUA</span>
        <span id="dateInfo">Updated Today</span>
    </div>

    <div class="nav-row">
        <button id="btnPrev" class="btn-nav" disabled>
            <i data-lucide="skip-back" width="18"></i> Prev
        </button>
        <button id="btnNext" class="btn-nav" disabled>
            Next <i data-lucide="skip-forward" width="18"></i>
        </button>
    </div>

    <div class="server-box">
        <div class="server-label">
            <span>PILIH SERVER</span>
            <span id="currentServer" style="color:var(--primary); font-weight:700">...</span>
        </div>
        <div class="server-grid" id="serverGrid">
            </div>
    </div>

    <a href="https://whatsapp.com/channel/0029Vb6kx8FFi8xZBhjm2g0m" target="_blank" class="btn-wa">
        <i data-lucide="message-circle" width="20" fill="white"></i> Gabung Saluran WA
    </a>

    <div style="text-align:center; margin-top:10px;" onclick="document.getElementById('dlSection').style.display='block'">
        <span style="font-size:0.8rem; color:#aaa; text-decoration:underline; cursor:pointer;">
            <i data-lucide="download" width="12"></i> Lihat Link Download
        </span>
    </div>

    <div class="dl-section" id="dlSection">
        <div id="dlContainer"></div>
    </div>

</div>

<div id="toast">Notifikasi</div>

<script>
    // CONFIG API
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";

    const urlParams = new URLSearchParams(window.location.search);
    const donghuaUrl = urlParams.get('url');

    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        if(donghuaUrl) loadDonghua(donghuaUrl);
        else document.getElementById('epTitle').innerText = "URL Tidak Valid";
    });

    async function loadDonghua(url) {
        try {
            const res = await fetch(`${API_DONGHUA}/detail?url=${encodeURIComponent(url)}`);
            const json = await res.json();
            
            if(!json || !json.streaming) throw new Error("Data Stream Error");

            // Set Info Header & Title
            document.getElementById('epTitle').innerText = json.episode;
            document.getElementById('headerTitle').innerText = json.episode;

            const servers = json.streaming.servers || [];
            
            // Default play: Coba cari "Premium" dulu, kalau tidak ada pakai index 0 (biasanya OK.ru atau default)
            // Tapi karena user bilang OK.ru bisa, kita biarkan logic defaultnya
            let defaultServer = servers[0]; // Ambil yang pertama
            
            // Render Server Buttons
            renderServers(servers, defaultServer.url);
            
            // Play Video Pertama
            playVideo(defaultServer.url, defaultServer.name);

            // Setup Navigasi & Download
            setupNav(json.navigation);
            renderDownload(json.download_url);
            
            // Simpan History
            saveHistory(json.episode, url);

        } catch (e) {
            console.error(e);
            document.getElementById('epTitle').innerText = "Gagal memuat: " + e.message;
        }
    }

    function playVideo(url, name) {
        const iframe = document.getElementById('iframePlayer');
        // Reset src agar player benar-benar reload (membersihkan sisa script iklan lama)
        iframe.src = 'about:blank';
        
        setTimeout(() => {
            iframe.src = url;
        }, 100);

        document.getElementById('currentServer').innerText = cleanName(name);
        showToast("Server: " + cleanName(name));
    }

    function renderServers(list, activeUrl) {
        const grid = document.getElementById('serverGrid');
        grid.innerHTML = "";

        list.forEach(srv => {
            const clean = cleanName(srv.name);
            const btn = document.createElement('div');
            btn.className = `btn-srv ${srv.url === activeUrl ? 'active' : ''}`;
            btn.innerText = clean;
            
            btn.onclick = () => {
                // Update UI tombol aktif
                document.querySelectorAll('.btn-srv').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Play server yang dipilih
                playVideo(srv.url, srv.name);
            };
            grid.appendChild(btn);
        });
    }

    function renderDownload(urls) {
        const box = document.getElementById('dlContainer');
        if(!urls) return;
        
        let html = "";
        for(let [k, v] of Object.entries(urls)) {
            let res = k.replace('download_url_', '').toUpperCase();
            html += `<div class="dl-item"><div style="font-size:0.75rem; color:#fff; margin-bottom:5px;">${res}</div><div class="dl-links">`;
            for(let [prov, link] of Object.entries(v)) {
                html += `<a href="${link}" target="_blank">${prov}</a>`;
            }
            html += `</div></div>`;
        }
        box.innerHTML = html;
    }

    function setupNav(nav) {
        const prev = document.getElementById('btnPrev');
        const next = document.getElementById('btnNext');

        if(nav.previous_episode?.anichinUrl) {
            prev.disabled = false;
            prev.onclick = () => location.href = `stream.html?url=${encodeURIComponent(nav.previous_episode.anichinUrl)}`;
        }
        if(nav.next_episode?.anichinUrl) {
            next.disabled = false;
            next.onclick = () => location.href = `stream.html?url=${encodeURIComponent(nav.next_episode.anichinUrl)}`;
        }
    }

    // Logic Force Fullscreen
    function toggleFullScreen() {
        const elem = document.getElementById('iframePlayer');
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) { /* Safari/iOS */
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
        }
    }

    function cleanName(str) {
        // Hilangkan [Ads], [V2], dll. Ambil huruf angka saja.
        return str.replace(/\[.*?\]/g, '').replace(/[^a-zA-Z0-9 ]/g, ' ').trim().toUpperCase();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 3000);
    }

    function saveHistory(title, url) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        hist = hist.filter(h => h.url !== url);
        hist.unshift({ title, url, source: 'donghua', date: new Date().toLocaleDateString() });
        localStorage.setItem('my_history', JSON.stringify(hist.slice(0, 20)));
    }
</script>
</body>
</html>
