<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Donghua</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px;"></div>

<header>
    <i data-lucide="arrow-left" onclick="history.back()" style="cursor:pointer; color:var(--text-main);"></i>
    <div class="logo" style="font-size:1.2rem;">STREAM</div>
    <div></div>
</header>

<div class="container" style="padding-top: 5px;">
    <div class="video-wrapper">
        <iframe id="iframePlayer" src="" allowfullscreen></iframe>
    </div>

    <h1 id="epTitle" style="font-size: 1.1rem; margin-bottom: 15px; font-weight: 700; line-height: 1.4;">Loading...</h1>

    <div style="display:flex; gap:10px; margin-bottom: 20px;">
        <button id="btnPrev" class="btn" style="flex:1; display:none;">&laquo; Prev</button>
        <button class="btn" style="flex:1; background:#222;" onclick="goToSeries()">Series Info</button>
        <button id="btnNext" class="btn" style="flex:1; display:none;">Next &raquo;</button>
    </div>

    <div class="box-panel">
        <div class="box-header">Ganti Server</div>
        <div id="serverList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    </div>

    <div class="box-panel">
        <div class="box-header" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleDl()">
            <span>Download Episode</span>
            <i data-lucide="chevron-down" id="dlIcon" style="transition:0.3s;"></i>
        </div>
        <div id="dlContainer" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:15px;"></div>
    </div>

    <div style="margin-top: 30px; margin-bottom: 10px;">
        <h3 class="section-title">Update Terbaru</h3>
        <div id="recommendationGrid" class="grid">
            <div class="card skeleton"></div>
            <div class="card skeleton"></div>
            <div class="card skeleton"></div>
        </div>
    </div>
</div>

<script>
    const API_BASE = "https://anichin-seven.vercel.app/api";
    const urlParams = new URLSearchParams(window.location.search);
    const animeUrl = urlParams.get('url');

    // Helper: Slug Cleaner
    function getSlug(url) {
        if(!url) return '';
        let clean = url.replace(/\/$/, '');
        let segment = clean.substring(clean.lastIndexOf('/') + 1);
        return segment.replace(/-episode-\d+.*$/i, '');
    }

    function goToSeries() {
        const slug = getSlug(animeUrl);
        window.location.href = `series.html?slug=${slug}`;
    }

    // --- MAIN LOGIC ---
    async function loadStream() {
        if (!animeUrl) return;

        try {
            // 1. Load Detail Stream
            const res = await fetch(`${API_BASE}/detail?url=${animeUrl}`);
            const json = await res.json();

            document.getElementById('epTitle').innerText = json.episode;
            document.getElementById('iframePlayer').src = json.streaming.main_url.url;

            // Render Servers
            document.getElementById('serverList').innerHTML = json.streaming.servers.map((srv, i) => 
                `<button class="btn ${i===0?'btn-primary':''}" style="font-size:0.75rem; padding:8px 12px;" onclick="changeServer('${srv.url}', this)">${srv.name}</button>`
            ).join('');

            // Render Nav
            if (json.navigation.previous_episode) {
                const btn = document.getElementById('btnPrev');
                btn.style.display = 'block';
                btn.onclick = () => window.location.href = `stream.html?url=${json.navigation.previous_episode.anichinUrl}`;
            }
            if (json.navigation.next_episode) {
                const btn = document.getElementById('btnNext');
                btn.style.display = 'block';
                btn.onclick = () => window.location.href = `stream.html?url=${json.navigation.next_episode.anichinUrl}`;
            }

            // Render Download
            let dlHtml = "";
            for (const [res, links] of Object.entries(json.download_url)) {
                dlHtml += `<div style="margin-bottom:10px;"><span style="color:var(--primary); font-size:0.75rem;">${res.replace('download_url_','').toUpperCase()}</span><div style="display:flex; gap:5px; margin-top:5px;">`;
                for (const [prov, url] of Object.entries(links)) {
                    dlHtml += `<a href="${url}" target="_blank" class="btn" style="font-size:0.7rem; padding:4px 10px;">${prov}</a>`;
                }
                dlHtml += `</div></div>`;
            }
            document.getElementById('dlContainer').innerHTML = dlHtml;

            saveToHistory(json.episode, animeUrl);
            lucide.createIcons();

        } catch (e) { console.error(e); }
    }

    // --- FITUR BARU: LOAD UPDATE TERBARU DI BAWAH ---
    async function loadRecommendations() {
        try {
            // Menggunakan API List sebagai "Update Terbaru"
            const res = await fetch(`${API_BASE}/list?page=1`);
            const data = await res.json();
            
            // Render 6 item saja biar tidak terlalu panjang
            const items = data.data.slice(0, 6);
            
            document.getElementById('recommendationGrid').innerHTML = items.map(item => {
                const slug = getSlug(item.href);
                return `
                <div class="card" onclick="window.location.href='series.html?slug=${slug}'">
                    <img src="${item.poster}" loading="lazy">
                    <div class="card-content">
                        <p>${item.title}</p>
                    </div>
                </div>
                `;
            }).join('');
            
        } catch(e) {
            document.getElementById('recommendationGrid').innerHTML = "<p>Gagal memuat update.</p>";
        }
    }

    // Helper UI
    function changeServer(url, btn) {
        document.getElementById('iframePlayer').src = url;
        document.querySelectorAll('#serverList .btn').forEach(b => b.classList.remove('btn-primary'));
        if(btn) btn.classList.add('btn-primary');
    }

    function toggleDl() {
        const el = document.getElementById('dlContainer');
        const icon = document.getElementById('dlIcon');
        if(el.style.display === 'none') {
            el.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            el.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    // History Logic (Simplified)
    function saveToHistory(title, url) {
        // ... (Kode history sama seperti sebelumnya, biarkan saja) ...
        // Jika perlu saya tulis ulang, kabari. Tapi intinya logic history tetap sama.
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        hist = hist.filter(h => h.url !== url);
        
        let poster = "https://via.placeholder.com/150";
        const slug = getSlug(url);
        
        // Coba fetch poster series
        fetch(`${API_BASE}/series?url=${slug}`).then(r=>r.json()).then(d=>{
            if(d.poster) poster = d.poster;
            finishSave();
        }).catch(() => finishSave());

        function finishSave() {
            hist.unshift({ title: title, url: url, poster: poster, date: new Date().toLocaleDateString() });
            localStorage.setItem('my_history', JSON.stringify(hist));
        }
    }

    loadStream();
    loadRecommendations(); // Panggil fungsi update terbaru
</script>
</body>
</html>
