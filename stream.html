<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonton - RayStream</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px;"></div>

<header>
    <div onclick="history.back()" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
        <i data-lucide="arrow-left" style="color:var(--text-main); width:22px;"></i>
        <span style="font-weight:600;">Kembali</span>
    </div>
    <div class="logo">STREAM</div>
    <div style="width:24px;"></div>
</header>

<div class="container" style="padding-top: 0; max-width: 850px;">
    
    <div class="video-area">
        <div class="video-wrapper">
            <div class="video-loader">
                <i data-lucide="loader-2" class="spin" style="width:40px; height:40px; animation: spin 1s linear infinite;"></i>
            </div>
            <iframe id="iframePlayer" src="" allowfullscreen allow="autoplay; encrypted-media"></iframe>
        </div>
    </div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

    <div class="stream-title-block">
        <h1 id="epTitle" class="ep-title">Memuat Video...</h1>
        <div class="ep-meta">
            <span id="badgeSrc" class="meta-badge" style="color:var(--primary);">SOURCE</span>
            <span class="meta-badge">HD</span>
            <span id="dateInfo">Updated Today</span>
        </div>
    </div>

    <div class="nav-buttons">
        <button id="btnPrev" class="btn-nav" style="display:none;">&laquo; Prev</button>
        <button class="btn-nav" onclick="goToSeries()">Info Series</button>
        <button id="btnNext" class="btn-nav primary" style="display:none;">Next &raquo;</button>
    </div>

    <div class="control-box">
        <div class="box-label"><i data-lucide="server" style="width:14px; vertical-align:middle;"></i> Server Stream</div>
        <div id="serverList" class="server-grid">
            <p style="font-size:0.8rem; color:#666;">Mencari server terbaik...</p>
        </div>
    </div>

    <div class="control-box">
        <div class="dl-header" onclick="toggleDl()">
            <div class="box-label" style="margin:0; display:flex; align-items:center; gap:8px;">
                <i data-lucide="download-cloud" style="width:16px;"></i> Download Link
            </div>
            <i data-lucide="chevron-down" id="dlIcon" style="transition:0.3s;"></i>
        </div>
        <div id="dlContainer" class="dl-content" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
            </div>
    </div>

    <div style="margin-top:40px;">
        <h3 class="section-header" style="padding:0; margin-bottom:15px;">Mungkin kamu suka</h3>
        <div id="recommendationGrid" class="grid"></div>
    </div>

</div>

<script>
    // --- SETUP API ---
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    // API Anime (Proxy Samehadaku)
    const API_ANIME_STREAM = "https://www.sankavollerei.com/anime/samehadaku"; 
    const API_ANIME_SERIES = "https://www.sankavollerei.com/anime/samehadaku";

    // --- AMBIL PARAMETER URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const donghuaUrl = urlParams.get('url');      
    const animeId = urlParams.get('id');          
    let source = urlParams.get('source'); // Bisa 'anime' atau 'donghua'

    // Smart Fallback
    if (!source) {
        if (animeId) source = 'anime';
        else if (donghuaUrl) source = 'donghua';
    }

    // ID CLEANER
    function cleanId(str) {
        if(!str) return "";
        return str.replace(/\/$/, '').split('/').pop();
    }

    // --- FUNGSI UTAMA LOAD STREAM ---
    async function loadStream() {
        try {
            // UI Badge
            const badge = document.getElementById('badgeSrc');
            badge.innerText = source === 'anime' ? "ANIME" : "DONGHUA";
            badge.style.color = source === 'anime' ? "#f59e0b" : "#3b82f6"; 

            let data = {};

            // === 1. MODE ANIME (MAPPING BARU SESUAI RESPON JSON) ===
            if (source === 'anime' && animeId) {
                const cleanAnimeId = cleanId(animeId);
                console.log("Fetching Anime ID:", cleanAnimeId);

                // Fetch ke Endpoint Episode
                const res = await fetch(`${API_ANIME_STREAM}/episode/${cleanAnimeId}`);
                if (!res.ok) throw new Error("API Anime Error/Down");
                
                const json = await res.json();
                if(!json.data) throw new Error("Episode tidak ditemukan");
                
                const d = json.data;
                
                // MAPPING DATA ANIME (UPDATED)
                // Stream URL: d.defaultStreamingUrl (Blogger)
                // Servers: d.server.qualities (Array)
                // Downloads: d.downloadUrl.formats (Array)
                
                data = {
                    title: d.title || cleanAnimeId,
                    stream: d.defaultStreamingUrl, 
                    // Kita akan ekstrak server list dari d.server.qualities
                    // Ambil server dari kualitas tertinggi (misal 1080p atau 720p)
                    servers: extractServers(d.server?.qualities),
                    downloads: d.downloadUrl?.formats || [],
                    
                    // Navigasi
                    prev: d.hasPrevEpisode ? `stream.html?id=${cleanId(d.prevEpisode.episodeId)}&source=anime` : null,
                    next: d.hasNextEpisode ? `stream.html?id=${cleanId(d.nextEpisode.episodeId)}&source=anime` : null
                };

                // Render Download Anime (Structure Baru)
                renderAnimeDownloads(data.downloads);

            // === 2. MODE DONGHUA (LAMA) ===
            } else if (donghuaUrl) {
                console.log("Fetching Donghua:", donghuaUrl);
                const res = await fetch(`${API_DONGHUA}/detail?url=${donghuaUrl}`);
                const json = await res.json();

                if(json.status === "error" || !json.streaming) throw new Error("Gagal mengambil data Donghua");

                data = {
                    title: json.episode,
                    stream: json.streaming.main_url.url,
                    servers: json.streaming.servers, // Structure [ {name, url}, ... ]
                    downloads: json.download_url,
                    prev: json.navigation.previous_episode ? `stream.html?url=${json.navigation.previous_episode.anichinUrl}&source=donghua` : null,
                    next: json.navigation.next_episode ? `stream.html?url=${json.navigation.next_episode.anichinUrl}&source=donghua` : null
                };

                // Render Download Donghua
                renderDonghuaDownloads(data.downloads);

            } else {
                throw new Error("Parameter URL tidak valid.");
            }

            // === 3. RENDER PLAYER & TITLE ===
            document.getElementById('epTitle').innerText = data.title;
            
            // Set Player
            const player = document.getElementById('iframePlayer');
            if(data.stream) {
                player.src = data.stream;
            } else {
                showToast("Stream utama kosong.", "error");
            }

            // Render Navigasi
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            
            if(data.prev) { btnPrev.style.display='block'; btnPrev.onclick = () => window.location.href = data.prev; }
            if(data.next) { btnNext.style.display='block'; btnNext.onclick = () => window.location.href = data.next; }

            // Render Server
            const sList = document.getElementById('serverList');
            if(data.servers && data.servers.length > 0) {
                // Handle beda format server object (Donghua: {name, url}, Anime: {title, serverId/href})
                // Untuk Anime kita perlu fetch lagi server url-nya, atau redirect?
                // API Anime Samehadaku ini server list-nya href="/samehadaku/server/XYZ". 
                // Ini butuh fetch lagi ke endpoint server. RIBET.
                // SEMENTARA: Kita hanya render server Donghua yang langsung URL.
                
                if (source === 'donghua') {
                    sList.innerHTML = data.servers.map((s, i) => 
                        `<button class="btn-server ${i===0?'active':''}" onclick="changePlayer('${s.url}', this)">${s.name}</button>`
                    ).join('');
                } else {
                    // Anime Server Handling (Advanced)
                    // API Samehadaku server list-nya butuh proses tambahan.
                    // Untuk sekarang kita tampilkan Default Stream (Blogger) saja.
                    sList.innerHTML = `<span style="font-size:0.8rem; color:#666;">Default Server (Blogger) Only. <br>Gunakan Download jika stream error.</span>`;
                }
            } else {
                sList.innerHTML = `<span style="font-size:0.8rem; color:#666;">Default Server Only</span>`;
            }

            // Save History
            const historyKey = source === 'anime' ? cleanId(animeId) : donghuaUrl;
            saveToHistory(data.title, historyKey, source);

        } catch (e) {
            console.error(e);
            document.getElementById('epTitle').innerText = "Gagal memuat: " + e.message;
            alert("Error: " + e.message);
        }
    }

    // --- HELPER: EXTRACT SERVERS (ANIME) ---
    function extractServers(qualities) {
        // Ini cuma dummy extraction, karena server anime butuh fetch detail lagi.
        // Kita return empty array biar gak error, fokus ke default stream dulu.
        return []; 
    }

    // --- RENDERERS ---
    
    // Anime Download Renderer (Format Samehadaku)
    function renderAnimeDownloads(formats) {
        if(!formats || formats.length === 0) return;
        let html = "";
        
        // formats: [{title: "MKV", qualities: [...]}, ...]
        formats.forEach(fmt => {
            html += `<div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px dashed #333;">`;
            html += `<div style="color:var(--primary); font-weight:700; font-size:0.85rem; margin-bottom:5px;">${fmt.title}</div>`; // MKV / MP4
            
            if(fmt.qualities) {
                fmt.qualities.forEach(q => {
                    html += `<div style="display:flex; flex-direction:column; gap:5px; margin-bottom:8px;">`;
                    html += `<span style="font-size:0.75rem; color:#aaa; font-weight:600;">${q.title}</span>`; // 360p / 480p
                    
                    html += `<div style="display:flex; flex-wrap:wrap; gap:6px;">`;
                    q.urls.forEach(u => {
                        html += `<a href="${u.url}" target="_blank" class="btn" style="padding:4px 10px; font-size:0.7rem; height:auto; background:#222; border:1px solid #333;">${u.title}</a>`;
                    });
                    html += `</div></div>`;
                });
            }
            html += `</div>`;
        });
        document.getElementById('dlContainer').innerHTML = html;
    }

    // Donghua Download Renderer
    function renderDonghuaDownloads(list) {
        if(!list) return;
        let html = "";
        for (const [k, v] of Object.entries(list)) {
            html += `<div style="margin-bottom:10px;"><div style="color:var(--primary); font-weight:700; font-size:0.8rem;">${k.replace('download_url_','').toUpperCase()}</div><div style="display:flex; gap:5px; flex-wrap:wrap;">`;
            for (const [p, u] of Object.entries(v)) {
                html += `<a href="${u}" target="_blank" class="btn" style="padding:4px 8px; font-size:0.7rem;">${p}</a>`;
            }
            html += `</div></div>`;
        }
        document.getElementById('dlContainer').innerHTML = html;
    }

    // --- UTILS ---
    function changePlayer(url, btn) {
        document.getElementById('iframePlayer').src = url;
        document.querySelectorAll('.btn-server').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        showToast("Server diganti", "success");
    }
    
    function toggleDl() {
        const el = document.getElementById('dlContainer');
        const icon = document.getElementById('dlIcon');
        if(el.style.display === 'none') {
            el.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            el.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function saveToHistory(title, key, src) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        hist = hist.filter(h => h.url !== key);
        
        let poster = "https://via.placeholder.com/150";
        // Fetch Background Poster (Optional)
        // ... (Kode fetch poster sama kayak sebelumnya) ...
        
        hist.unshift({ title, url: key, source: src, poster: poster, date: new Date().toLocaleDateString() });
        localStorage.setItem('my_history', JSON.stringify(hist));
    }

    function goToSeries() {
        let slug = source === 'anime' ? animeId.replace(/-episode-\d+.*$/i, '') : ""; 
        if(!slug && donghuaUrl) slug = getSlugFromUrl(donghuaUrl);
        
        if(slug) window.location.href = `series.html?slug=${slug}&source=${source}`;
        else window.history.back();
    }
    
    function getSlugFromUrl(url) {
        let clean = url.replace(/\/$/, '');
        let segment = clean.substring(clean.lastIndexOf('/') + 1);
        return segment.replace(/-episode-\d+.*$/i, '');
    }

    function showToast(msg, type) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.style.borderLeft = type === 'error' ? '4px solid #ef4444' : '4px solid #22c55e';
        t.innerHTML = `<span>${msg}</span>`;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // Load Recommendation (Bottom)
    async function loadRec() {
        try {
            const res = await fetch(`${API_DONGHUA}/list?page=1`);
            const data = await res.json();
            document.getElementById('recommendationGrid').innerHTML = data.data.slice(0,6).map(item => `
                <div class="card" onclick="window.location.href='series.html?slug=${getSlugFromUrl(item.href)}&source=donghua'">
                    <img src="${item.poster}">
                    <p>${item.title}</p>
                </div>
            `).join('');
        } catch(e) {}
    }

    loadStream();
    loadRec();
    lucide.createIcons();
</script>
