<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonton - RayStream</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px;"></div>

<header>
    <div onclick="history.back()" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
        <i data-lucide="arrow-left" style="color:var(--text-main); width:22px;"></i>
        <span style="font-weight:600;">Kembali</span>
    </div>
    <div class="logo">STREAM</div>
    <div style="width:24px;"></div>
</header>

<div class="container" style="padding-top: 0; max-width: 850px;">
    
    <div class="video-area">
        <div class="video-wrapper">
            <div class="video-loader">
                <i data-lucide="loader-2" class="spin" style="width:40px; height:40px; animation: spin 1s linear infinite;"></i>
            </div>
            <iframe id="iframePlayer" src="" allowfullscreen allow="autoplay; encrypted-media"></iframe>
        </div>
    </div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

    <div class="stream-title-block">
        <h1 id="epTitle" class="ep-title">Memuat Video...</h1>
        <div class="ep-meta">
            <span id="badgeSrc" class="meta-badge" style="color:var(--primary);">SOURCE</span>
            <span class="meta-badge">HD</span>
            <span id="dateInfo">Updated Today</span>
        </div>
    </div>

    <div class="nav-buttons">
        <button id="btnPrev" class="btn-nav" style="display:none;">&laquo; Prev</button>
        <button class="btn-nav" onclick="goToSeries()">Info Series</button>
        <button id="btnNext" class="btn-nav primary" style="display:none;">Next &raquo;</button>
    </div>

    <div class="control-box">
        <div class="box-label"><i data-lucide="server" style="width:14px; vertical-align:middle;"></i> Server Stream</div>
        <div id="serverList" class="server-grid">
            <p style="font-size:0.8rem; color:#666;">Mencari server terbaik...</p>
        </div>
    </div>

    <div class="control-box">
        <div class="dl-header" onclick="toggleDl()">
            <div class="box-label" style="margin:0; display:flex; align-items:center; gap:8px;">
                <i data-lucide="download-cloud" style="width:16px;"></i> Download Link
            </div>
            <i data-lucide="chevron-down" id="dlIcon" style="transition:0.3s;"></i>
        </div>
        <div id="dlContainer" class="dl-content" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
            </div>
    </div>

    <div style="margin-top:40px;">
        <h3 class="section-header" style="padding:0; margin-bottom:15px;">Mungkin kamu suka</h3>
        <div id="recommendationGrid" class="grid"></div>
    </div>

</div>
<script>
    // --- SETUP API ---
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    // API Anime (Sesuai request lu)
    const API_ANIME_STREAM = "https://donghua-qnha.vercel.app/anime/samehadaku"; 
    const API_ANIME_SERIES = "https://www.sankavollerei.com/anime/samehadaku";

    const urlParams = new URLSearchParams(window.location.search);
    let donghuaUrl = urlParams.get('url');      
    let animeId = urlParams.get('id');          
    let source = urlParams.get('source'); 

    // --- 1. ID CLEANER (PEMBERSIH ID) ---
    // Fungsi ini wajib ada biar API gak error kalau ID-nya kotor
    function cleanId(str) {
        if(!str) return "";
        // Hapus domain dan path, sisakan slug terakhir
        // Contoh: "https://web.com/episode/one-piece-1155/" -> "one-piece-1155"
        return str.replace(/\/$/, '').split('/').pop();
    }

    // Fallback Source Detection
    if (!source) {
        if (animeId) source = 'anime';
        else if (donghuaUrl) source = 'donghua';
    }

    // --- 2. LOAD STREAM ---
    async function loadStream() {
        try {
            // UI Setup
            const badge = document.getElementById('badgeSrc'); // Pastikan elemen ini ada di HTML
            if(badge) {
                badge.innerText = source === 'anime' ? "ANIME" : "DONGHUA";
                badge.style.background = source === 'anime' ? "#f59e0b" : "#6366f1";
            }

            let streamData = {};

            // === MODE ANIME ===
            if (source === 'anime' && animeId) {
                // Bersihkan ID sebelum dikirim ke API
                const cleanAnimeId = cleanId(animeId);
                console.log("Fetching Anime ID:", cleanAnimeId);

                const res = await fetch(`${API_ANIME_STREAM}/episode/${cleanAnimeId}`);
                if (!res.ok) throw new Error("API Anime Error/Down");
                
                const json = await res.json();
                if(!json.data) throw new Error("Episode tidak ditemukan");
                
                const d = json.data;
                
                streamData = {
                    title: d.title || cleanAnimeId,
                    stream: d.streamUrl, 
                    servers: [], 
                    downloads: d.downloads || [],
                    prev: d.navigation.prev ? `stream.html?id=${cleanId(d.navigation.prev)}&source=anime` : null,
                    next: d.navigation.next ? `stream.html?id=${cleanId(d.navigation.next)}&source=anime` : null
                };

                // Render Download Anime
                renderAnimeDownloads(streamData.downloads);

            // === MODE DONGHUA ===
            } else if (donghuaUrl) {
                const res = await fetch(`${API_DONGHUA}/detail?url=${donghuaUrl}`);
                const json = await res.json();
                
                if(!json.streaming) throw new Error("Stream Donghua Error");

                streamData = {
                    title: json.episode,
                    stream: json.streaming.main_url.url,
                    servers: json.streaming.servers,
                    downloads: json.download_url,
                    prev: json.navigation.previous_episode ? `stream.html?url=${json.navigation.previous_episode.anichinUrl}&source=donghua` : null,
                    next: json.navigation.next_episode ? `stream.html?url=${json.navigation.next_episode.anichinUrl}&source=donghua` : null
                };

                // Render Download Donghua
                renderDonghuaDownloads(streamData.downloads);
            } 

            // === RENDER PLAYER ===
            document.getElementById('epTitle').innerText = streamData.title;
            
            const player = document.getElementById('iframePlayer');
            // Cek jika link stream itu Iframe FB atau bukan
            if(streamData.stream) {
                player.src = streamData.stream;
            } else {
                alert("Link streaming kosong!");
            }

            // Render Navigasi
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            
            if(streamData.prev) { btnPrev.style.display='block'; btnPrev.onclick = () => window.location.href = streamData.prev; }
            if(streamData.next) { btnNext.style.display='block'; btnNext.onclick = () => window.location.href = streamData.next; }

            // Render Servers (Donghua Only usually)
            const sList = document.getElementById('serverList');
            if(sList) {
                if(streamData.servers && streamData.servers.length > 0) {
                    sList.innerHTML = streamData.servers.map((s, i) => 
                        `<button class="btn ${i===0?'btn-primary':''}" onclick="changePlayer('${s.url}', this)">${s.name}</button>`
                    ).join('');
                } else {
                    sList.innerHTML = `<span style="font-size:0.8rem; color:#666;">Default Server Only</span>`;
                }
            }

            // Save History (dengan ID bersih)
            const historyKey = source === 'anime' ? cleanId(animeId) : donghuaUrl;
            saveToHistory(streamData.title, historyKey, source);

        } catch (e) {
            console.error(e);
            document.getElementById('epTitle').innerText = "Gagal memuat: " + e.message;
            alert("Error: " + e.message);
        }
    }

    // --- RENDERERS ---
    function renderAnimeDownloads(list) {
        if(!list || list.length === 0) return;
        let html = "";
        list.forEach(g => {
            html += `<div style="margin-bottom:10px;"><div style="color:var(--primary); font-weight:700; font-size:0.8rem;">${g.title}</div>`;
            if(g.qualities) {
                g.qualities.forEach(q => {
                    html += `<div style="display:flex; gap:5px; margin-top:5px; align-items:center;"><span style="font-size:0.7rem; width:40px;">${q.title}</span>`;
                    q.urls.forEach(u => {
                        html += `<a href="${u.url}" target="_blank" class="btn" style="padding:4px 8px; font-size:0.7rem;">${u.title}</a>`;
                    });
                    html += `</div>`;
                });
            }
            html += `</div>`;
        });
        document.getElementById('dlContainer').innerHTML = html;
    }

    function renderDonghuaDownloads(list) {
        if(!list) return;
        let html = "";
        for (const [k, v] of Object.entries(list)) {
            html += `<div style="margin-bottom:10px;"><div style="color:var(--primary); font-weight:700; font-size:0.8rem;">${k.replace('download_url_','').toUpperCase()}</div><div style="display:flex; gap:5px; flex-wrap:wrap;">`;
            for (const [p, u] of Object.entries(v)) {
                html += `<a href="${u}" target="_blank" class="btn" style="padding:4px 8px; font-size:0.7rem;">${p}</a>`;
            }
            html += `</div></div>`;
        }
        document.getElementById('dlContainer').innerHTML = html;
    }

    // --- UTILS ---
    function changePlayer(url, btn) {
        document.getElementById('iframePlayer').src = url;
        // logic active button class...
    }
    
    function toggleDl() {
        const el = document.getElementById('dlContainer');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function saveToHistory(title, key, src) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        hist = hist.filter(h => h.url !== key);
        
        // Simple poster fallback (karena fetch background kadang bikin lemot)
        let poster = "https://via.placeholder.com/150";
        
        hist.unshift({ title, url: key, source: src, poster: poster, date: new Date().toLocaleDateString() });
        localStorage.setItem('my_history', JSON.stringify(hist));
    }

    function goToSeries() {
        let slug = source === 'anime' ? animeId.replace(/-episode-\d+.*$/i, '') : ""; 
        // Logic extract slug donghua kalo perlu
        if(slug) window.location.href = `series.html?slug=${slug}&source=${source}`;
        else window.history.back();
    }

    // Start
    loadStream();
    lucide.createIcons();
</script>

</body>
</html>
